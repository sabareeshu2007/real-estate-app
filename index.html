<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatePro - Geo Location</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root { --primary: #2563eb; --bg: #f3f4f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: #1f2937; }

        /* Navigation */
        nav { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .nav-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .nav-btn.active { background: var(--primary); color: white; }

        /* Layout */
        .container { max-width: 900px; margin: 30px auto; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }

        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #4b5563; }
        input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        
        button.primary { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: 600; }
        button.primary:hover { background: #1d4ed8; }

        /* Maps */
        .map-box { height: 300px; width: 100%; border-radius: 8px; border: 2px solid #e5e7eb; margin-top: 10px; }
        .info-box { background: #eff6ff; color: #1e40af; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; text-align: center;}
    </style>
</head>
<body>

    <nav>
        <h3 style="margin:0;">EstatePro üìç</h3>
        <div id="nav-buttons">
            <button class="nav-btn" onclick="showLogin('owner')">Owner Portal</button>
            <button class="nav-btn" onclick="showLogin('tenant')">Tenant Search</button>
        </div>
        <button id="logout-btn" class="nav-btn hidden" onclick="location.reload()">Logout</button>
    </nav>

    <div id="auth-section" class="container">
        <div class="card" style="max-width:400px; margin:auto;">
            <h2 id="auth-title">Login</h2>
            <input type="email" id="email-input" placeholder="Email">
            <br><br>
            <input type="password" id="pass-input" placeholder="Password">
            <br><br>
            <button class="primary" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="owner-section" class="container hidden">
        <div class="card">
            <h2>List Your Property</h2>
            <p style="color:#666; font-size:14px;">Please fill in the details below and pin the location on the map.</p>
            
            <h4>1. Personal Details</h4>
            <div class="form-grid">
                <div><label>First Name</label><input type="text" id="fname"></div>
                <div><label>Last Name</label><input type="text" id="lname"></div>
                <div class="full-width"><label>Phone Number</label><input type="tel" id="phone"></div>
            </div>

            <h4>2. Address Details</h4>
            <div class="form-grid">
                <div><label>House No / Flat</label><input type="text" id="house"></div>
                <div><label>Street Name</label><input type="text" id="street"></div>
                <div class="full-width"><label>Area / Neighborhood</label><input type="text" id="area"></div>
                <div><label>City</label><input type="text" id="city"></div>
                <div><label>State</label><input type="text" id="state"></div>
                <div class="full-width"><label>Country</label><input type="text" id="country"></div>
            </div>

            <h4>3. Pin Exact Location</h4>
            <p style="font-size:12px; color:orange;">‚ö† Click on the map to set the location pin.</p>
            <div id="owner-map" class="map-box"></div>
            
            <div id="coords-display" class="info-box hidden">
                Selected Location: <span id="lat-val">0</span>, <span id="lng-val">0</span>
            </div>
            <br>
            <button class="primary" onclick="submitListing()">Submit Listing</button>
        </div>
    </div>

    <div id="tenant-section" class="container hidden">
        <div class="card">
            <h2>Find a Home</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="search-city" placeholder="Enter City (e.g. New York, Chennai)">
                <button class="primary" style="width:auto;" onclick="searchProperties()">Search</button>
            </div>
        </div>
        
        <div class="card">
            <div id="tenant-map" class="map-box" style="height: 500px;"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE WITH YOUR RENDER URL (or http://localhost:3000/api if testing locally)
        const API_URL = 'https://real-estate-app-925m.onrender.com/api'; 
        
        let currentUserType = '';
        let currentUserEmail = '';
        let ownerMap, tenantMap;
        let selectedLat = null; 
        let selectedLng = null;
        let ownerMarker = null;

        // --- AUTH ---
        function showLogin(type) {
            currentUserType = type;
            document.getElementById('auth-title').innerText = type + ' Login';
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('owner-section').classList.add('hidden');
            document.getElementById('tenant-section').classList.add('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            if(!email || !password) return alert("Fill all fields");

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password, userType: currentUserType })
                });
                const data = await res.json();
                
                if(data.success) {
                    currentUserEmail = email;
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('nav-buttons').classList.add('hidden');
                    document.getElementById('logout-btn').classList.remove('hidden');

                    if(currentUserType === 'owner') {
                        document.getElementById('owner-section').classList.remove('hidden');
                        initOwnerMap(); // Load the map for pinning
                    } else {
                        document.getElementById('tenant-section').classList.remove('hidden');
                        initTenantMap(); // Load the search map
                    }
                } else { alert(data.message); }
            } catch(e) { console.error(e); alert("Login Error"); }
        }

        // --- OWNER LOGIC (PIN THE MAP) ---
        function initOwnerMap() {
            // Default center (can be anywhere)
            ownerMap = L.map('owner-map').setView([20.5937, 78.9629], 4); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ownerMap);

            // Add Click Event Listener
            ownerMap.on('click', function(e) {
                selectedLat = e.latlng.lat;
                selectedLng = e.latlng.lng;

                // Remove old marker if exists
                if (ownerMarker) ownerMap.removeLayer(ownerMarker);

                // Add new marker
                ownerMarker = L.marker([selectedLat, selectedLng]).addTo(ownerMap);

                // Show coordinates
                document.getElementById('coords-display').classList.remove('hidden');
                document.getElementById('lat-val').innerText = selectedLat.toFixed(4);
                document.getElementById('lng-val').innerText = selectedLng.toFixed(4);
            });
            
            // Fix map size glitch
            setTimeout(() => ownerMap.invalidateSize(), 100);
        }
        async function submitListing() {
            // 1. Get Values
            const form = {
                ownerEmail: currentUserEmail,
                firstName: document.getElementById('fname').value,
                lastName: document.getElementById('lname').value,
                phone: document.getElementById('phone').value,
                houseNo: document.getElementById('house').value,
                street: document.getElementById('street').value,
                area: document.getElementById('area').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                country: document.getElementById('country').value,
                lat: selectedLat,
                lng: selectedLng
            };

            // 2. Validation
            if(!form.firstName || !form.phone || !form.city) return alert("Please fill basic details");
            if(!form.lat) return alert("Please click on the map to pin the location!");

            // 3. Send to Server
            try {
                const res = await fetch(`${API_URL}/list-property`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(form)
                });
                const data = await res.json();
                
                if(data.success) {
                    alert("‚úÖ Details Submitted Successfully!\n\nOur sales team will contact you within 48 hours.");
                    
                    // --- THE FIX IS HERE ---
                    // Instead of location.reload(), we just clear the boxes:
                    document.getElementById('fname').value = '';
                    document.getElementById('lname').value = '';
                    document.getElementById('phone').value = '';
                    document.getElementById('house').value = '';
                    document.getElementById('street').value = '';
                    document.getElementById('area').value = '';
                    document.getElementById('city').value = '';
                    document.getElementById('state').value = '';
                    document.getElementById('country').value = '';
                    
                    // Remove the pin from the map
                    if (ownerMarker) {
                        ownerMap.removeLayer(ownerMarker);
                        ownerMarker = null;
                    }
                    document.getElementById('coords-display').classList.add('hidden');
                }
            } catch(e) { alert("Error submitting listing"); }
        }

        // --- TENANT LOGIC (SEARCH & DISPLAY) ---
        function initTenantMap() {
            tenantMap = L.map('tenant-map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(tenantMap);
            setTimeout(() => tenantMap.invalidateSize(), 100);
        }

        async function searchProperties() {
            const city = document.getElementById('search-city').value;
            if(!city) return alert("Enter a city name");

            // 1. Move Map to City (Using Nominatim Geocoding)
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
            const geoData = await geoRes.json();

            if(geoData.length > 0) {
                const lat = geoData[0].lat;
                const lon = geoData[0].lon;
                tenantMap.setView([lat, lon], 12);
            } else {
                alert("City not found on map, but checking database...");
            }

            // 2. Fetch Properties from OUR Database
            try {
                const res = await fetch(`${API_URL}/search-properties?city=${city}`);
                const data = await res.json();

                // Clear existing pins
                tenantMap.eachLayer((layer) => {
                    if(layer instanceof L.Marker) tenantMap.removeLayer(layer);
                });

                if(data.properties.length > 0) {
                    // 3. Plot Each Property
                    data.properties.forEach(prop => {
                        if(prop.lat && prop.lng) {
                            L.marker([prop.lat, prop.lng]).addTo(tenantMap)
                             .bindPopup(`
                                <b>${prop.houseNo}, ${prop.street}</b><br>
                                ${prop.area}<br>
                                Owner: ${prop.firstName}<br>
                                Phone: ${prop.phone}
                             `);
                        }
                    });
                    alert(`Found ${data.properties.length} properties in ${city}!`);
                } else {
                    alert("No properties listed in this city yet.");
                }

            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>