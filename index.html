<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatePro - Secure Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #6C63FF; --secondary: #2A2A72; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin: 0; min-height: 100vh; }
        
        /* Navigation */
        nav { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo { font-weight: 700; font-size: 20px; color: var(--secondary); }
        .nav-btn { border: 1px solid var(--primary); color: var(--primary); padding: 8px 20px; border-radius: 20px; background: white; cursor: pointer; }
        
        /* Containers */
        .container { max-width: 900px; margin: 40px auto; padding: 20px; }
        .hidden { display: none !important; }

        /* Auth Card */
        .auth-card { 
            background: white; width: 100%; max-width: 400px; margin: 50px auto; 
            padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center;
        }

        .toggle-group { display: flex; background: #f1f2f6; padding: 5px; border-radius: 10px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; color: #636e72; }
        .toggle-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; }
        button.primary { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; }
        
        .switch-link { margin-top: 15px; font-size: 13px; color: #636e72; cursor: pointer; }
        .switch-link span { color: var(--primary); font-weight: 600; text-decoration: underline; }

        /* Dashboard & Maps */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .map-box { height: 400px; width: 100%; border-radius: 15px; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Form Grid for Listing */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        .full-width { grid-column: span 2; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">üè† EstatePro</div>
        <button id="logout-btn" class="nav-btn hidden" onclick="handleLogout()">Logout</button>
    </nav>

    <div id="auth-section" class="container">
        <div class="auth-card">
            <h2 id="auth-title">Welcome Back</h2>
            
            <div class="toggle-group">
                <button id="btn-owner" class="toggle-btn active" onclick="setPortal('owner')">Owner Portal</button>
                <button id="btn-tenant" class="toggle-btn" onclick="setPortal('tenant')">Find Home</button>
            </div>

            <div id="signup-fields" class="hidden">
                <input type="text" id="reg-fname" placeholder="First Name">
                <input type="text" id="reg-lname" placeholder="Last Name">
                <input type="tel" id="reg-phone" placeholder="Phone Number">
            </div>

            <input type="email" id="email-input" placeholder="Email Address">
            <input type="password" id="pass-input" placeholder="Password">
            
            <button class="primary" id="submit-btn" onclick="handleAuth()">Login</button>

            <div class="switch-link" onclick="toggleAuthMode()">
                <p id="switch-text">New here? <span>Create Account</span></p>
            </div>
        </div>
    </div>

    <div id="owner-section" class="container hidden">
        <div class="dashboard-header">
            <h2>My Dashboard</h2>
            <button class="nav-btn" onclick="loadMyListings()">Refresh Status</button>
        </div>
        
        <div style="background:white; padding:30px; border-radius:15px; margin-bottom:20px;">
            <h3>List Property</h3>
            <div class="form-grid">
                <input type="text" id="prop-address" class="full-width" placeholder="Full Address (Street, Area)">
                <input type="text" id="prop-area" placeholder="Area Name">
                <input type="text" id="prop-city" value="Chennai">
            </div>
            <p style="font-size:12px; color:orange;">üëá Click Map to Pin Location</p>
            <div id="owner-map" class="map-box" style="height:300px;"></div>
            <button class="primary" style="margin-top:15px;" onclick="submitListing()">Submit Listing</button>
        </div>

        <h3>Listings Status</h3>
        <div id="my-listings"></div>
    </div>

    <div id="tenant-section" class="container hidden">
        <h2>Find Homes</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="search-query" placeholder="Search Area (e.g. T Nagar)">
            <button class="primary" style="width:auto;" onclick="searchProperties()">Search</button>
        </div>
        <div id="tenant-map" class="map-box"></div>
    </div>

    <script>
        // --- CONFIG ---
        // REPLACE WITH YOUR RENDER URL
        const API_URL = 'https://real-estate-app-925m.onrender.com/api'; 
        
        let currentPortal = 'owner'; // 'owner' or 'tenant'
        let isLoginMode = true;      // true = Login, false = Sign Up
        let ownerMap, tenantMap, selectedLat, selectedLng, ownerMarker;

        // --- AUTH LOGIC ---
        function setPortal(type) {
            currentPortal = type;
            document.getElementById('btn-owner').className = type === 'owner' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('btn-tenant').className = type === 'tenant' ? 'toggle-btn active' : 'toggle-btn';
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode; // Switch mode
            
            const title = document.getElementById('auth-title');
            const fields = document.getElementById('signup-fields');
            const btn = document.getElementById('submit-btn');
            const switchText = document.getElementById('switch-text');

            if (isLoginMode) {
                // Show Login View
                title.innerText = "Welcome Back";
                fields.classList.add('hidden');
                btn.innerText = "Login";
                switchText.innerHTML = "New here? <span>Create Account</span>";
            } else {
                // Show Sign Up View
                title.innerText = "Create Account";
                fields.classList.remove('hidden');
                btn.innerText = "Sign Up";
                switchText.innerHTML = "Already have an account? <span>Login</span>";
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            
            // Endpoint depends on mode
            const endpoint = isLoginMode ? '/login' : '/register';
            
            // Payload
            let payload = { email, password, userType: currentPortal };
            
            if (!isLoginMode) {
                // Add extra fields for registration
                payload.firstName = document.getElementById('reg-fname').value;
                payload.lastName = document.getElementById('reg-lname').value;
                payload.phone = document.getElementById('reg-phone').value;
                
                if(!payload.firstName || !payload.phone) return alert("Please fill all details");
            }

            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    // Save Token & Redirect
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('email', email);
                    localStorage.setItem('type', currentPortal);
                    
                    checkSession(); // Load dashboard
                } else {
                    alert(data.message);
                }
            } catch (e) { alert("Connection Error"); }
        }

        // --- SESSION LOGIC ---
        function checkSession() {
            const token = localStorage.getItem('token');
            const type = localStorage.getItem('type');
            
            if(token && type) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                
                if(type === 'owner') {
                    document.getElementById('owner-section').classList.remove('hidden');
                    initOwnerMap();
                } else {
                    document.getElementById('tenant-section').classList.remove('hidden');
                    initTenantMap();
                }
            }
        }
        
        function handleLogout() {
            localStorage.clear();
            location.reload();
        }

        // --- MAPS & LISTING (Simplified for length) ---
        function initOwnerMap() {
            if(ownerMap) return;
            ownerMap = L.map('owner-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ownerMap);
            ownerMap.on('click', e => {
                selectedLat = e.latlng.lat; selectedLng = e.latlng.lng;
                if(ownerMarker) ownerMap.removeLayer(ownerMarker);
                ownerMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(ownerMap);
            });
            setTimeout(() => ownerMap.invalidateSize(), 500);
        }

        async function submitListing() {
            const form = {
                ownerEmail: localStorage.getItem('email'),
                street: document.getElementById('prop-address').value,
                area: document.getElementById('prop-area').value,
                city: document.getElementById('prop-city').value,
                lat: selectedLat, lng: selectedLng
            };
            if(!form.lat) return alert("Pin Location on Map!");
            
            await fetch(`${API_URL}/list-property`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form)
            });
            alert("Property Listed!");
            location.reload();
        }

        function initTenantMap() {
            if(tenantMap) return;
            tenantMap = L.map('tenant-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(tenantMap);
            setTimeout(() => tenantMap.invalidateSize(), 500);
        }

        async function searchProperties() {
            const q = document.getElementById('search-query').value;
            const res = await fetch(`${API_URL}/search-properties?query=${q}`);
            const data = await res.json();
            
            // Move map to first result or search area
            if(data.properties.length > 0) {
                 tenantMap.setView([data.properties[0].lat, data.properties[0].lng], 13);
                 data.properties.forEach(p => {
                     L.marker([p.lat, p.lng]).addTo(tenantMap).bindPopup(`<b>${p.area}</b><br>${p.street}`);
                 });
            } else { alert("No listings found."); }
        }

        // Run on load
        checkSession();
    </script>
</body>
</html>