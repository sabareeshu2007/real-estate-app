<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatePro - Full Platform</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- PAGE TRANSITIONS --- */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* This class triggers the animation */
        .animate-view {
            animation: slideUpFade 0.4s ease-out forwards;
        }

        /* Make the List Property Page look distinct */
        #owner-section {
            background: #fff;
            min-height: 80vh;
            padding-top: 20px;
        }
        /* ADMIN STYLES */
        .admin-header { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: white; padding: 20px; border-radius: 15px; border-left: 5px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-num { font-size: 32px; font-weight: 700; color: var(--secondary); }
        .verify-btn { background: #2ecc71; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; }
        .verified-badge { background: #e3f2fd; color: #2ecc71; padding: 2px 6px; border-radius: 4px; font-size: 10px; border: 1px solid #2ecc71; }
        /* --- UTILITY CLASSES FROM INLINE STYLES --- */
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .modal-header h2 { margin:0; }
        .modal-header .close-btn { font-size:24px; cursor:pointer; }

        /* --- FILTER MODAL STYLES --- */
        #filter-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .filter-box { background: white; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 15px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        .filter-section { margin-bottom: 20px; }
        .filter-section h4 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        
        .filter-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-chip { border: 1px solid #ddd; background: white; padding: 8px 15px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .filter-chip.selected { background: var(--secondary); color: white; border-color: var(--secondary); }
        
        .range-labels { display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: var(--primary); margin-bottom: 5px;}
        input[type=range] { width: 100%; padding: 0; margin: 0; }
        /* --- PROFESSIONAL DESIGN VARIABLES --- */
        :root { 
            --primary: #6C63FF; 
            --secondary: #2A2A72;
            --danger: #e74c3c;
            --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* --- NEW UTILITY CLASSES --- */
        .text-center { text-align: center; }
        .w-auto { width: auto !important; }
        .mt-15 { margin-top: 15px; }
        .mt-50 { margin-top: 50px; }
        .mb-0 { margin-bottom: 0 !important; }
        .auth-card {
            max-width: 450px; margin: 50px auto; text-align: center;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); min-height: 100vh; color: #2d3436; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* NAV */
        nav { 
            background: var(--glass); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 24px; font-weight: 700; color: var(--secondary); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { text-decoration: none; color: #636e72; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .nav-links a:hover { color: var(--primary); }
        .btn-login { border: 2px solid var(--primary); color: var(--primary) !important; padding: 8px 25px; border-radius: 30px; font-weight: 600; }
        .btn-logout { margin-left: 20px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: 600; }
        .btn-login:hover { background: var(--primary); color: white !important; }

        /* UTILS */
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; animation: fadeIn 0.8s ease; }
        .hidden { display: none !important; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
        
        /* INPUTS & BUTTONS */
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid #dfe6e9; border-radius: 10px; font-size: 14px; background: #f9f9f9; margin-bottom: 15px; }
        input:focus { outline: none; border-color: var(--primary); background: white; }
        
        .btn { padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s; text-align: center; display: block; text-decoration: none; }
        .btn-primary { background: linear-gradient(45deg, var(--secondary), var(--primary)); color: white; box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-outline { border: 1px solid var(--primary); background: transparent; color: var(--primary); }
        .btn-whatsapp { background: #25D366; color: white; }
        
        /* --- HOME PAGE SPECIFIC --- */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover; background-position: center; height: 500px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
        }
        .search-hero { background: white; padding: 10px; border-radius: 50px; display: flex; gap: 10px; width: 90%; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .search-hero input { border: none; background: transparent; margin: 0; padding: 10px 20px; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px; }
        .prop-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer; }
        .prop-card:hover { transform: translateY(-10px); }
        .prop-img { height: 200px; width: 100%; object-fit: cover; }
        .prop-info { padding: 20px; }

        .blog-card { border-left: 5px solid var(--primary); padding: 20px; }
        
        footer { background: var(--secondary); color: white; padding: 50px 10%; margin-top: 50px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; }
        footer a { color: #b2bec3; display: block; margin-bottom: 10px; font-size: 14px; text-decoration: none; }

        /* --- DASHBOARD SPECIFIC --- */
        .map-box { height: 350px; width: 100%; border-radius: 15px; border: 2px solid white; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; background: #f1f2f6; padding: 10px; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f1f2f6; font-size: 14px; }
        .status-badge { background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } 
        .full-width { grid-column: span 2; }
        
        /* IMAGE UPLOAD GRID */
        .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .upload-item { background: #f8f9fa; padding: 10px; border-radius: 10px; text-align: center; border: 1px dashed #ccc; }
        .upload-item label { font-size: 11px; font-weight: bold; display: block; margin-bottom: 5px; }
        .upload-item input { width: 100%; font-size: 10px; padding: 0; background: transparent; border: none; }

        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #f1f2f6; padding: 5px 10px; border-radius: 5px; }
        .checkbox-item input { width: auto; margin: 0; }

        .btn-sm { width: auto; padding: 5px 15px; font-size: 12px; display: inline-block; margin-right: 5px; border-radius: 5px; cursor: pointer; color: white; border: none; }
        .bg-orange { background: #f39c12; }
        .bg-red { background: #e74c3c; }

        /* --- PROPERTY DETAIL PAGE --- */
        .gallery-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 400px; margin-bottom: 30px; }
        .main-img { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; background: #ddd; }
        .side-imgs { display: flex; flex-direction: column; gap: 15px; }
        .sub-img { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; background: #eee; }
        
        .details-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; }
        .highlights { display: flex; gap: 20px; margin: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 20px 0; }
        .highlight-item { text-align: center; flex: 1; border-right: 1px solid #eee; font-size: 14px; }
        .highlight-item i { font-size: 20px; color: var(--primary); margin-bottom: 5px; }
        
        .amenity-tag { background: #e3f2fd; color: var(--primary); padding: 8px 15px; border-radius: 20px; font-size: 13px; display: inline-block; margin: 5px; }
        
        .price-card { position: sticky; top: 100px; border: 1px solid #eee; }
        .emi-box { background: #e3f2fd; padding: 20px; border-radius: 15px; margin-top: 30px; }

        /* --- NEW STYLES FOR MOBILE & LIGHTBOX --- */
        
        /* 1. Lightbox (Full Screen Zoom) */
        #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; 
            display: flex; justify-content: center; align-items: center;
        }
        #lightbox img { max-width: 95%; max-height: 80vh; border-radius: 5px; }
        .close-lb { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; }

        /* 2. Gallery Layouts */
        /* --- FIXED GALLERY CSS --- */
        .gallery-desktop { 
            display: grid; 
            grid-template-columns: 2fr 1fr; /* Main image takes 2 parts, side images take 1 part */
            gap: 10px; 
            height: 400px; /* FORCE FIXED HEIGHT */
            width: 100%;
            margin-bottom: 20px;
            overflow: hidden; /* Cut off anything that sticks out */
        }
        
        .gallery-right { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 2 columns */
            grid-template-rows: 1fr 1fr;    /* 2 rows */
            gap: 10px; 
            height: 100%;
        }
        
        .gal-img { 
            width: 100%; 
            height: 100%; /* Force image to match the box height */
            object-fit: cover; /* CRITICAL: Crops the image so it doesn't stretch */
            border-radius: 10px; 
            cursor: pointer; 
            transition: 0.3s; 
            background-color: #eee; /* Light gray background if image loads slow */
            display: block;
        }
        
        .gal-img:hover { opacity: 0.9; }

        .gallery-mobile { display: none; } /* Hidden on Desktop */

            /* --- PRO SEARCH BAR CSS --- */
            /* --- TABBED SEARCH BAR DESIGN --- */
            .hero-search-container {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                padding: 20px;
                border-radius: 15px;
                width: 90%;
                max-width: 700px;
                margin-top: 20px;
            }

            /* 1. The Tabs (Buy / Rent / Commercial) */
            .search-tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                justify-content: center;
            }
            
            .tab-item {
                color: white;
                padding: 8px 20px;
                cursor: pointer;
                font-weight: 500;
                opacity: 0.8;
                border-bottom: 3px solid transparent;
                transition: 0.3s;
            }
            
            .tab-item.active {
                opacity: 1;
                font-weight: 700;
                border-bottom: 3px solid var(--primary); /* Use brand color */
            }

            /* 2. The Search Box */
            .search-box-clean {
                background: white;
                border-radius: 8px;
                display: flex;
                align-items: center;
                padding: 5px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            }

            /* Location Dropdown / Icon */
            .city-select {
                border: none;
                /*border-right: 1px solid #ddd;*/
                padding: 5px; /* More compact padding */
                background: transparent;
                font-weight: 500; /* Less bold */
                font-size: 14px; /* Smaller font */
                color: #333;
                cursor: pointer;
                outline: none;
            }

            /* The Input Field */
            .search-box-clean input {
                border: none;
                width: 100%;
                padding: 15px;
                font-size: 15px;
                outline: none;
            }

            /* The Red Search Button */
            .search-btn-red {
                background: var(--primary);
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 6px;
                font-weight: 600;
                font-size: 16px;
                cursor: pointer;
                transition: 0.3s;
            }
            .search-btn-red:hover { background: var(--secondary); }
            
            /* Filter Icon */
            .filter-icon-btn {
                padding: 10px 15px;
                cursor: pointer;
                color: #666;
                border-left: 1px solid #eee;
            }
            /* --- LOADING SPINNER CSS --- */
            #loading-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(255, 255, 255, 0.9); z-index: 10000;
                display: flex; justify-content: center; align-items: center; flex-direction: column;
            }
            .spinner {
                width: 50px; height: 50px; border: 5px solid #e3e3e3;
                border-top: 5px solid var(--primary); border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            /* --- EDIT PHOTO STYLES --- */
            .img-preview-box { position: relative; margin-top: 5px; display: none; } /* Hidden by default */
            .img-preview-box img { width: 100%; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
            .btn-remove-img {
                position: absolute; top: -5px; right: -5px;
                background: red; color: white; border: none;
                border-radius: 50%; width: 20px; height: 20px;
                font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            }
            /* --- FIND HOMES PAGE (SEARCH UI) --- */
            .search-layout { display: flex; height: calc(100vh - 70px); overflow: hidden; }
            
            /* Left Sidebar (Filters) */
            .filter-sidebar { 
                width: 400px; background: white; border-right: 1px solid #eee; 
                overflow-y: auto; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 100;
            }
            
            /* Top Tabs */
            .filter-tabs { display: flex; border-bottom: 2px solid #f1f2f6; margin-bottom: 20px; }
            .ft-btn { 
                flex: 1; text-align: center; padding: 12px; font-weight: 600; color: #888; 
                cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s;
            }
            .ft-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

            /* Sections */
            .f-section { margin-bottom: 25px; border-bottom: 1px solid #f9f9f9; padding-bottom: 15px; }
            .f-title { font-size: 12px; font-weight: 700; color: #b2bec3; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }

            /* Search Input */
            .search-loc-box { 
                display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 10px; 
                margin-bottom: 20px; transition: 0.3s;
            }
            .search-loc-box:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1); }
            .search-loc-box input { border: none; outline: none; width: 100%; font-size: 14px; margin: 0; padding-left: 10px; }

            /* Grid Chips (Property Type, etc) */
            .chip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .chip { 
                border: 1px solid #e0e0e0; border-radius: 5px; padding: 10px; text-align: center; 
                font-size: 13px; cursor: pointer; transition: 0.2s; color: #555; background: white;
            }
            .chip:hover { border-color: var(--primary); color: var(--primary); }
            .chip.selected { background: var(--secondary); color: white; border-color: var(--secondary); }

            /* Range Sliders */
            .range-wrap { margin-top: 10px; }
            .range-val { display: flex; justify-content: space-between; font-weight: 600; font-size: 14px; color: var(--primary); margin-bottom: 5px; }
            input[type=range] { width: 100%; cursor: pointer; accent-color: var(--primary); height: 5px; }

            /* Bottom Search Button */
            .sticky-search-btn {
                position: sticky; bottom: 0; background: white; padding-top: 10px; border-top: 1px solid #eee;
            }

            /* Right Map Area */
            .map-container-full { position: relative; flex: 1; }
            #tenant-map { width: 100%; height: 100%; }
            .btn-map-back {
                position: absolute; top: 20px; left: 20px; z-index: 1000;
                background: white; border: none; padding: 10px 15px; border-radius: 30px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; font-weight: 600;
            }

            /* --- CONSOLIDATED MEDIA QUERY --- */
            @media (max-width: 768px) {
                /* Layouts */
                .form-grid, .details-layout, .gallery-grid, footer { grid-template-columns: 1fr; }
                .full-width { grid-column: span 1; }

                /* Navigation */
                nav { padding: 15px; flex-direction: column; gap: 10px; }
                .nav-links { width: 100%; justify-content: center; gap: 15px; }
                .logo { margin-bottom: 5px; }

                /* Search Page (Tenant View) */
                .search-layout { 
                    display: flex !important;
                    flex-direction: column !important;
                    height: auto !important; /* Allow scrolling */
                    overflow: visible !important;
                }
                .map-container-full { 
                    order: -1; /* Moves map to top */
                    height: 300px !important;
                    flex: none; /* IMPORTANT: Reset flex behavior for the mobile column layout */
                    min-height: 300px; /* Add a minimum height safeguard */
                    width: 100% !important;
                    position:relative; /* Ensure positioning context */
                    flex-shrink: 0; /* Prevent the map from shrinking */
                }
                #tenant-map { height: 100% !important; width: 100% !important; }
                .filter-sidebar { 
                    order: 2; /* Filters below map */
                    width: 100% !important; 
                    height: auto !important;
                    overflow-y: visible !important;
                    padding-bottom: 80px;
                }
                .sticky-search-btn {
                    position: fixed; 
                    bottom: 0; left: 0; width: 100%; 
                    padding: 15px; background: white; 
                    border-top: 1px solid #ddd; z-index: 1000;
                }

                /* Property Detail Page */
                .gallery-desktop { display: none; }
                .gallery-mobile { 
                    display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scroll-snap-type: x mandatory; 
                }
                .gallery-mobile img { 
                    width: 85vw; height: 250px; object-fit: cover; border-radius: 10px; flex-shrink: 0; scroll-snap-align: center; 
                }
                .gallery-grid { height: 250px; }
                .highlights { flex-wrap: wrap; gap: 10px; }
                .highlight-item { flex: 1 1 40%; margin-bottom: 10px; }
                .price-card { position: static; margin-top: 20px; }
            }

            /* --- SKELETON LOADING STYLES --- */
            .skeleton {
                background: #f0f0f0;
                border-radius: 4px;
                overflow: hidden;
                position: relative;
            }

            /* The Shimmer Animation */
            .skeleton::after {
                content: "";
                display: block;
                position: absolute;
                top: 0; left: 0; width: 100%; height: 100%;
                transform: translateX(-100%);
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                animation: loading 1.5s infinite;
            }

            @keyframes loading {
                100% { transform: translateX(100%); }
            }

            /* Skeleton Card Layout */
            .sk-card {
                background: white;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            }
            .sk-img { width: 100%; height: 200px; }
            .sk-info { padding: 20px; }
            .sk-line { height: 20px; margin-bottom: 10px; width: 80%; }
            .sk-line-sm { height: 15px; width: 50%; }

            /* --- FIXED FAVORITE BUTTON CSS --- */
            .fav-btn {
                position: absolute;
                top: 10px; 
                right: 10px;
                background: #ffffff !important; /* Force White Background */
                width: 35px; 
                height: 35px;
                border-radius: 50%;
                display: flex; 
                justify-content: center; 
                align-items: center;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                z-index: 100 !important; /* Force it to be on TOP of the card */
                transition: transform 0.2s ease;
            }

            /* Hover Animation */
            .fav-btn:hover { 
                transform: scale(1.1); 
                background: #f8f9fa !important; /* Slight grey bg on hover */
            }

            /* Icon Default State */
            .fav-btn i {
                color: #ccc !important; /* Grey by default */
                font-size: 18px;
                pointer-events: none; /* Allows click to pass through icon to the button */
            }

            /* Icon Hover State (When hovering the BUTTON, not just the icon) */
            .fav-btn:hover i {
                color: #e74c3c !important; /* Turn Red on Hover */
            }

            /* Active State (Saved) */
            .fav-btn.active i {
                color: #e74c3c !important; /* Force Red */
                font-weight: 900 !important; /* Solid Heart */
            }
    </style>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>
    <div id="filter-modal" class="hidden">
        <div class="filter-box">
            <div class="modal-header">
                <h2>‚öôÔ∏è Filters</h2>
                <span id="filter-modal-close" class="close-btn">&times;</span>
            </div>

            <div class="filter-section">
                <h4>I want to...</h4>
                <div class="filter-grid" id="f-listing">
                    <span class="filter-chip selected" onclick="selectOpt('f-listing', this, 'Buy')">Buy</span>
                    <span class="filter-chip" onclick="selectOpt('f-listing', this, 'Rent')">Rent</span>
                </div>
            </div>

            <div class="filter-section">
                <h4>Property Type</h4>
                <div class="filter-grid" id="f-prop">
                    <span class="filter-chip" onclick="selectOpt('f-prop', this, 'House')">House</span>
                    <span class="filter-chip" onclick="selectOpt('f-prop', this, 'Apartment')">Apartment</span>
                    <span class="filter-chip" onclick="selectOpt('f-prop', this, 'Office')">Office</span>
                    <span class="filter-chip" onclick="selectOpt('f-prop', this, 'Shop')">Shop</span>
                </div>
            </div>

            <div class="filter-section">
                <h4>Max Price: <span id="price-val">Any</span></h4>
                <input type="range" min="0" max="50000000" step="1000" value="0" oninput="updateRange('price-val', this.value, '‚Çπ ')">
            </div>

            <div class="filter-section">
                <h4>Max Area: <span id="sqft-val">Any</span></h4>
                <input type="range" min="0" max="10000" step="100" value="0" oninput="updateRange('sqft-val', this.value, '', ' sqft')">
            </div>

            <button id="apply-filters-btn" class="btn btn-primary">Apply Filters</button>
        </div>
    </div>
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p id="loading-msg" style="margin-top:15px; font-weight:600; color:#666;">Processing...</p>
    </div>
    <div id="lightbox" class="hidden" onclick="closeLightbox()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column;">
        <span id="lightbox-close" style="position:absolute; top:20px; right:30px; color:white; font-size:40px; cursor:pointer;">&times;</span>
        <img id="lightbox-img" src="" style="max-width:90%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(255,255,255,0.2);">
    </div>

    <nav>
        <div id="logo" class="logo">üè† EstatePro</div>
        <div class="nav-links">
            <a id="nav-home">Home</a>
            <a id="nav-list-property">List Property</a>
            <a id="nav-saved" onclick="loadFavoritesPage()">Saved</a>
            <a id="nav-login" class="btn-login">Login</a>
        </div> 
        <button id="logout-btn" class="hidden btn-logout">Logout</button>
    </nav>

    <div id="home-page">
        <header class="hero">
            <h1 class="mb-0">Find Your Perfect Home</h1>
            
            <div class="hero-search-container">
                <div class="search-tabs">
                    <div class="tab-item" onclick="setSearchTab(this,'Buy')">Buy</div> 
                    <div class="tab-item" data-value="Rent">Rent</div>
                    <div class="tab-item" data-value="Commercial">Commercial</div>
                </div>

                <div class="search-box-clean">
                    <select class="city-select">
                        <option>Chennai</option>
                        <option>Bangalore</option>
                    </select>

                    <input type="text" id="home-search-input" placeholder="Search up to 3 Localities..." autocomplete="off" name="search_unique_xyz">
                    
                    <div id="hero-filter-btn" class="filter-icon-btn" title="Advanced Filters">
                        <i class="fas fa-sliders-h"></i>
                    </div>

                    <button id="hero-search-btn" class="search-btn-red">
                        Search
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <h2 class="text-center mt-50">Featured Properties</h2>
            <div class="grid-container" id="featured-list">
                <p style="text-align:center; width:100%;">Loading latest properties...</p>
            </div>

            <h2 class="text-center" style="margin-top: 60px;">Latest Real Estate News</h2>
            <div class="grid-container">
                <div class="card blog-card">
                    <h4>üìà Top 5 Areas to Invest</h4>
                    <p style="font-size:12px; color:#999;">Oct 12, 2025</p>
                    <p style="color:#666; font-size:14px;">Anna Nagar and OMR are seeing the highest appreciation...</p>
                </div>
                <div class="card blog-card">
                    <h4>üí∞ Home Loan Rates Drop</h4>
                    <p style="font-size:12px; color:#999;">Nov 01, 2025</p>
                    <p style="color:#666; font-size:14px;">New RBI policies make buying more affordable...</p>
                </div>
                <div class="card blog-card">
                    <h4>üè° Interior Design Trends</h4>
                    <p style="font-size:12px; color:#999;">Nov 20, 2025</p>
                    <p style="color:#666; font-size:14px;">Minimalist designs are taking over the 2025 scene...</p>
                </div>
            </div>
        </div>

        <footer>
                <div>
                    <h4>EstatePro</h4>
                    <p style="font-size:13px; opacity:0.8;">The #1 Real Estate platform in Chennai.</p>
                </div>
                <div>
                    <h4>Company</h4>
                    <a href="#">About Us</a>
                    <a href="#">Careers</a>
                    <a href="#">Contact</a>
                </div>
                <div>
                    <h4>Legal</h4>
                    <a href="#">Terms</a>
                    <a href="#">Privacy</a>
                </div>
                <div>
                    <h4>Social</h4>
                    <a href="#">Facebook</a>
                    <a href="#">Instagram</a>
                </div>
        </footer>
    </div>

    <div id="admin-dashboard" class="container hidden">
        <h2 style="margin-bottom:20px;">üëÆ‚Äç‚ôÇÔ∏è Admin Control Panel</h2>
        
        <div class="admin-header">
            <div class="card" style="margin-bottom: 25px;">
                <h3>Platform Analytics</h3>
                <div style="height: 300px; width: 100%; display: flex; justify-content: center;">
                    <canvas id="listingChart"></canvas>
                </div>
            </div>
            <div class="stat-card">
                <h4>Total Users</h4>
                <div class="stat-num" id="stat-users">0</div>
            </div>
            <div class="stat-card">
                <h4>Total Listings</h4>
                <div class="stat-num" id="stat-props">0</div>
            </div>
        </div>

        <div class="card">
            <h3>All Properties Database</h3>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee; text-align:left;"><th>Details</th><th>Owner</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
            <button class="btn btn-primary" onclick="loadAdminData()" style="width:auto; margin-top:15px;">Refresh Data</button>
        </div>
    </div>

    <div id="app-section" class="container hidden">
        
        <div id="auth-section" class="card auth-card">
            <h2 id="auth-title">Welcome Back</h2>
            
            <div id="signup-fields" class="hidden">
                <input type="text" id="reg-name" placeholder="Full Name">
                <input type="tel" id="reg-phone" placeholder="Phone Number">
            </div>

            <input type="email" id="email-input" placeholder="Email Address">
            <input type="password" id="pass-input" placeholder="Password">
            
            <button id="auth-btn" class="btn btn-primary">Login</button>
            
            <div style="margin-top:20px; display:flex; justify-content:space-between; font-size:13px;">
                <span id="switch-text" style="color:var(--primary); cursor:pointer; font-weight:600;">New here? Create Account</span>
                <span id="auth-back-home" style="color:#666; cursor:pointer;">‚Üê Back to Home</span>
            </div>
        </div>

        <div id="owner-section" class="hidden">
            <div class="card">
                <h2>üìä My Listings</h2>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Property</th><th>Status</th><th>Actions</th></tr></thead><tbody id="my-listings-body"></tbody></table>
                </div>
                <button id="refresh-listings-btn" class="btn btn-primary w-auto mt-15">Refresh Status</button>
            </div>

            <div class="card" id="listing-form-card">
                <h2 id="form-title">üìç List New Property</h2>
                <div class="form-grid">
                    <input type="text" id="fname" placeholder="Owner Name">
                    <input type="tel" id="phone" placeholder="Contact Phone">
                    
                    <div class="full-width">
                        <label style="font-size:12px; font-weight:600; color:#666;">Listing Type</label>
                        <select id="o-listingType" style="background:#eef2f3;">
                            <option value="Rent">For Rent</option>
                            <option value="Buy">For Sale</option>
                        </select>
                    </div>

                    <div class="full-width"><input type="text" id="house" placeholder="Full Address (House No, Street)"></div>
                    <input type="text" id="area" placeholder="Area / Neighborhood">
                    <input type="text" id="city" value="Chennai">
                    
                    <input type="number" id="price" placeholder="Price / Rent (‚Çπ)">
                    <input type="number" id="sqft" placeholder="Size (Sq. Ft)">
                    
                    <div>
                        <label style="font-size:11px; font-weight:bold;">Property Type</label>
                        <select id="o-propType">
                            <option value="Apartment">Apartment</option>
                            <option value="House">Independent House</option>
                            <option value="Villa">Villa</option>
                            <option value="Office Space">Office Space</option>
                            <option value="Shop">Shop</option>
                            <option value="Showroom">Showroom</option>
                            <option value="Co-Working">Co-Working</option>
                            <option value="Warehouse">Warehouse</option>
                            <option value="Industrial">Industrial Bldg</option>
                            <option value="Restaurant">Restaurant/Cafe</option>
                        </select>
                    </div>

                    <div>
                        <label style="font-size:11px; font-weight:bold;">Building Type</label>
                        <select id="o-buildType">
                            <option value="Independent">Independent Building</option>
                            <option value="Mall">Mall</option>
                            <option value="Business Park">Business Park</option>
                            <option value="Standalone">Standalone Commercial</option>
                            <option value="Gated Community">Gated Community</option>
                        </select>
                    </div>

                    <div>
                        <label style="font-size:11px; font-weight:bold;">Furnishing</label>
                        <select id="o-furnish">
                            <option value="Semi">Semi-Furnished</option>
                            <option value="Full">Fully Furnished</option>
                            <option value="None">Unfurnished</option>
                        </select>
                    </div>

                    <div>
                        <label style="font-size:11px; font-weight:bold;">Parking</label>
                        <select id="o-parking">
                            <option value="Reserved">Reserved Parking</option>
                            <option value="Public">Public / Street</option>
                            <option value="None">No Parking</option>
                        </select>
                    </div>

                    <select id="beds"><option value="">Beds (If House)</option><option value="1">1 BHK</option><option value="2">2 BHK</option><option value="3">3 BHK</option><option value="4">4+ BHK</option></select>
                    <select id="baths"><option value="">Baths</option><option value="1">1 Bath</option><option value="2">2 Baths</option><option value="3">3+ Baths</option></select>
                    
                    <div class="full-width"><textarea id="desc" rows="3" placeholder="Description (e.g. Near Metro, Sea Facing)"></textarea></div>
                    <div class="full-width" style="margin-top:20px;">
                        <label style="font-weight:600; color:#555;">Upload Photos:</label>
                        <div class="upload-grid">
                            
                            <div class="upload-item">
                                <label>Outer</label>
                                <input type="file" id="img-outer">
                                <div id="preview-outer" class="img-preview-box" data-type="outer">
                                    <img src="">
                                    <button class="btn-remove-img">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Hall</label>
                                <input type="file" id="img-hall">
                                <div id="preview-hall" class="img-preview-box" data-type="hall">
                                    <img src="">
                                    <button class="btn-remove-img">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Bed</label>
                                <input type="file" id="img-bed">
                                <div id="preview-bed" class="img-preview-box" data-type="bed">
                                    <img src="">
                                    <button class="btn-remove-img">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Kitchen</label>
                                <input type="file" id="img-kitchen">
                                <div id="preview-kitchen" class="img-preview-box" data-type="kitchen">
                                    <img src="">
                                    <button class="btn-remove-img">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Bath</label>
                                <input type="file" id="img-bath">
                                <div id="preview-bath" class="img-preview-box" data-type="bath">
                                    <img src="">
                                    <button class="btn-remove-img">√ó</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

                <h4 style="margin-top:20px;">Amenities</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Lift"> Lift</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Gym"> Gym</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Parking"> Parking</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Security"> Security</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Power Backup"> Power Backup</div>
                </div>

                <h4 style="margin-top:20px;">Pin Exact Location</h4>
                <div style="position:relative;">
                    <input type="text" id="owner-map-search" placeholder="Search Map (e.g. T Nagar)" style="position:absolute; top:10px; left:50px; z-index:999; width:200px;">
                    <button id="owner-map-search-btn" style="position:absolute; top:10px; left:260px; z-index:999; width:40px; padding:10px; cursor:pointer;">üîç</button>
                    <div id="owner-map" class="map-box"></div>
                </div>
                <p id="coords-display" style="text-align:center; color:green; display:none; margin-top:5px;">‚úÖ Location Pinned!</p>

                <button class="btn btn-primary" id="submit-btn" style="margin-top:20px;">Submit Listing</button>
                <button class="btn btn-outline hidden" id="cancel-edit-btn" style="margin-top:5px;">Cancel Edit</button>
            </div>
        </div>
        
        <div id="favorites-section" class="container hidden">
            <h2 class="text-center mt-50">‚ù§Ô∏è My Saved Homes</h2>
            
            <button onclick="showAuth('tenant')" class="btn-outline" style="width:auto; margin-bottom:20px; padding: 5px 15px;">‚Üê Back to Search</button>

            <div class="grid-container" id="fav-list-container">
                <p class="text-center">Loading your favorites...</p>
            </div>
        </div>

        <div id="tenant-section" class="hidden">
        <div class="search-layout">
            
            <div class="filter-sidebar">
                
                <div class="filter-tabs">
                    <div class="ft-btn active" data-value="Buy">Buy</div>
                    <div class="ft-btn" data-value="Rent">Rent</div>
                    <div class="ft-btn" data-value="Commercial">Commercial</div>
                </div>

                <div class="search-loc-box">
                    <i class="fas fa-search" style="color:#888;"></i>
                    <input type="text" id="f-loc" placeholder="Search Locality (e.g. Anna Nagar)">
                </div>

                <div class="f-section">
                    <div class="f-title">Property Type</div>
                    <div class="chip-grid" id="f-prop-grid">
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Office Space')">Office Space</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Co-Working')">Co-Working</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Shop')">Shop</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Showroom')">Showroom</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Warehouse')">Warehouse</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Industrial')">Industrial</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Restaurant')">Restaurant</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'House')">House/Villa</div>
                        <div class="chip" onclick="selectSingle('f-prop-grid', this, 'Apartment')">Apartment</div>
                    </div>
                </div>

                <div class="f-section">
                    <div class="f-title">Price Range</div>
                    <div class="range-wrap">
                        <div class="range-val"><span>‚Çπ 0</span><span id="disp-price">Any</span></div>
                        <input type="range" min="0" max="100000000" step="1000" value="0" oninput="updateRangeLabel('disp-price', this.value, '‚Çπ ')">
                    </div>
                </div>

                <div class="f-section">
                    <div class="f-title">Built-Up Area</div>
                    <div class="range-wrap">
                        <div class="range-val"><span>0 sq.ft</span><span id="disp-sqft">Any</span></div>
                        <input type="range" min="0" max="10000" step="100" value="0" oninput="updateRangeLabel('disp-sqft', this.value, '', ' sqft')">
                    </div>
                </div>

                <div class="f-section">
                    <div class="f-title">Furnishing</div>
                    <div class="chip-grid" id="f-furnish-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="chip" onclick="selectSingle('f-furnish-grid', this, 'Full')">Full</div>
                        <div class="chip" onclick="selectSingle('f-furnish-grid', this, 'Semi')">Semi</div>
                        <div class="chip" onclick="selectSingle('f-furnish-grid', this, 'None')">None</div>
                    </div>
                </div>

                <div class="f-section">
                    <div class="f-title">Building Type</div>
                    <div class="chip-grid" id="f-build-grid">
                        <div class="chip" onclick="selectSingle('f-build-grid', this, 'Independent')">Independent</div>
                        <div class="chip" onclick="selectSingle('f-build-grid', this, 'Mall')">Mall</div>
                        <div class="chip" onclick="selectSingle('f-build-grid', this, 'Business Park')">Business Park</div>
                        <div class="chip" onclick="selectSingle('f-build-grid', this, 'Standalone')">Standalone</div>
                    </div>
                </div>

                <div class="f-section">
                    <div class="f-title">Parking</div>
                    <div class="chip-grid" id="f-park-grid">
                        <div class="chip" onclick="selectSingle('f-park-grid', this, 'Public')">Public</div>
                        <div class="chip" onclick="selectSingle('f-park-grid', this, 'Reserved')">Reserved</div>
                    </div>
                </div>

                <div class="sticky-search-btn">
                    <button id="tenant-search-btn" class="btn btn-primary">SEARCH</button>
                </div>
            </div>

            <div class="map-container-full">
                <div id="tenant-map"></div>
                <button id="tenant-back-btn" class="btn-map-back">‚Üê Back</button>
            </div>
        </div>
    </div>

    <div id="property-page" class="hidden">
        <div class="container">
            <button id="property-page-back-btn" style="background:none; border:none; cursor:pointer; margin-bottom:15px; font-size:16px;">‚Üê Back to Map</button>
            
            <div class="gallery-desktop">
                <img id="dt-img-1" class="gal-img" onclick="openLightbox(this.src)" 
                     onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
                
                <div class="gallery-right">
                    <img id="dt-img-2" class="gal-img" onclick="openLightbox(this.src)" 
                         onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <img id="dt-img-3" class="gal-img" onclick="openLightbox(this.src)" 
                         onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <img id="dt-img-4" class="gal-img" onclick="openLightbox(this.src)" 
                         onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <img id="dt-img-5" class="gal-img" onclick="openLightbox(this.src)" 
                         onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                </div>
            </div>
            
            <div class="gallery-mobile">
                <img id="m-img-1" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
                <img id="m-img-2" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <img id="m-img-3" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <img id="m-img-4" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <img id="m-img-5" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
            </div>
            
            <div class="details-layout">
                <div class="main-content">
                    <h1 id="dt-title" style="margin:0;">Property Title</h1>
                    <p id="dt-addr" style="color:#666; margin-top:5px;">Address Location</p>
                    
                    <div class="highlights">
                        <div class="highlight-item"><i class="fas fa-ruler-combined"></i><br><b><span id="dt-sqft"></span></b> Sqft</div>
                        <div class="highlight-item"><i class="fas fa-bed"></i><br><b><span id="dt-beds"></span></b> Beds</div>
                        <div class="highlight-item"><i class="fas fa-bath"></i><br><b><span id="dt-baths"></span></b> Baths</div>
                        <div class="highlight-item"><i class="fas fa-couch"></i><br><b><span id="dt-furnish"></span></b></div>
                    </div>

                    <h3>Description</h3>
                    <p id="dt-desc" style="color:#555; line-height:1.6;"></p>

                    <h3>Amenities</h3>
                    <div id="dt-amenities" style="margin-bottom:30px;"></div>

                    <h3>Location</h3>
                    <div id="detail-map" class="map-box" style="height:250px;"></div>
                    <a id="dt-sv" href="#" target="_blank" class="btn btn-outline" style="margin-top:15px;">üëÄ Open 360¬∞ Street View</a>

                    <div class="emi-box">
                        <h3 style="margin-top:0;">EMI Calculator</h3>
                        <input type="number" id="loan-amount" placeholder="Loan Amount (e.g. 5000000)" oninput="calculateEMI()">
                        <div style="text-align:center; font-size:20px; font-weight:700; color:var(--primary); margin-top:10px;">Monthly EMI: <span id="emi-val">‚Çπ 0</span></div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="card price-card">
                        <div style="font-size:32px; font-weight:700; color:var(--secondary);">‚Çπ <span id="dt-price"></span></div>
                        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                        <h4>Owner Details</h4>
                        <p style="font-size:18px; font-weight:600;"><span id="dt-owner"></span></p>
                        <a id="dt-call" href="#" class="btn btn-primary"><i class="fas fa-phone"></i> Call Now</a>
                        <a id="dt-wa" href="#" target="_blank" class="btn btn-whatsapp" style="margin-top:10px;"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                    </div>
                    
                    <div class="card">
                        <h4>Nearby Essentials</h4>
                        <ul style="padding-left:20px; line-height:2; color:#666;">
                            <li>üè´ School: 0.5 km</li>
                            <li>üè• Hospital: 1.2 km</li>
                            <li>üöÜ Metro: 2.0 km</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // ‚ö†Ô∏è REPLACE WITH YOUR RENDER URL
        // Note: I've added a setupEventListeners() function at the bottom of the script to centralize event handling.
        const API_URL = 'https://real-estate-app-925m.onrender.com/api'; // REPLACE
        const CLOUD_NAME = 'dfsotxfxg';      // REPLACE
        const UPLOAD_PRESET = 'estate'; // REPLACE 

        let currentUserType = 'owner';
        let ownerMap, tenantMap, detailMap; 
        let selectedLat, selectedLng, ownerMarker;
        let isLoginMode = true, isEditing = false, editingId = null;
        let currentImages = {}; // Stores the current photos while editing
        let allMyProperties = []; // Stores full property data
        let searchFilters = { listingType: '', propertyType: '', price: 0, sqft: 0 };
        let adminChart = null; // Global variable to hold chart instance
        let myFavorites = []; // Store IDs locally for quick UI checks
        // --- ADVANCED FILTER STATE ---
        let activeFilters = {
            listingType: '', // Default
            propertyType: '',
            price: 0,
            sqft: 0,
            furnishing: '',
            buildingType: '',
            parking: ''
        };

        // --- LOAD FAVORITES PAGE ---
        async function loadFavoritesPage() {
            // 1. SECURITY CHECK (Do this FIRST)
            const token = localStorage.getItem('token');
            if (!token) {
                showToast("üîí Please Login to view your favorites", "error");
                showAuth('tenant'); // Force user to Login Screen
                return; // Stop here! Do not show the page.
            }

            // 2. NOW it is safe to show the section
            document.querySelectorAll('.container, #home-page, #tenant-section').forEach(el => el.classList.add('hidden'));
            
            // Hide Property Page explicitly just in case
            document.getElementById('property-page').classList.add('hidden');

            const section = document.getElementById('favorites-section');
            section.classList.remove('hidden');
            section.classList.add('animate-view');

            // 3. Fetch Data
            const email = localStorage.getItem('email');
            const container = document.getElementById('fav-list-container');
            container.innerHTML = '<p style="text-align:center; margin-top:20px;">Loading your favorites...</p>';

            try {
                const res = await fetch(`${API_URL}/get-favorites-details`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (!data.properties || data.properties.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; width:100%; grid-column: 1/-1; margin-top: 30px;">
                            <h3 style="color:#ccc;">No favorites yet üíî</h3>
                            <p style="color:#888;">Go back and heart some properties!</p>
                        </div>`;
                    return;
                }

                // 4. Render Cards
                container.innerHTML = data.properties.map(p => {
                    const img = (p.images && p.images.outer) ? p.images.outer : 'https://via.placeholder.com/300x200';
                    const safeProp = JSON.stringify(p).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                    return `
                    <div class="prop-card" style="position:relative;">
                        <div class="fav-btn active" onclick="toggleFav(this, '${p._id}', event); setTimeout(loadFavoritesPage, 500);" data-id="${p._id}">
                            <i class="fa-solid fa-heart"></i>
                        </div>
                        <div style="cursor:pointer;" onclick='openPropertyPage(${safeProp})'>
                            <img src="${img}" class="prop-img">
                            <div class="prop-info">
                                <h3 style="margin:0; color:var(--primary);">‚Çπ ${Number(p.price).toLocaleString()}</h3>
                                <p style="color:#666;">${p.bedrooms || 2} BHK in ${p.area}</p>
                            </div>
                        </div>
                    </div>`;
                }).join('');

            } catch (e) { console.error(e); }
        }
        async function refreshFavorites() {
            const email = localStorage.getItem('email');
            if (!email) return;

            try {
                const res = await fetch(`${API_URL}/user-favorites/${email}`);
                const data = await res.json();
                if (data.success) {
                    myFavorites = data.favorites || [];
                    updateHeartIcons(); // Helper to color hearts on page
                }
            } catch (e) { console.error("Fav Error", e); }
        }
        async function toggleFav(btn, propId, event) {
            event.stopPropagation(); // Stop the card click (which opens details)
            
            const email = localStorage.getItem('email');
            if (!email) return showToast("‚ö†Ô∏è Please Login to save favorites", "error");

            // 1. Optimistic UI Update (Change color immediately)
            const icon = btn.querySelector('i');
            const isNowActive = !btn.classList.contains('active');
            
            if (isNowActive) {
                btn.classList.add('active');
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
            } else {
                btn.classList.remove('active');
                icon.classList.add('fa-regular');
                icon.classList.remove('fa-solid');
            }

            // 2. Send to Server
            try {
                const res = await fetch(`${API_URL}/toggle-favorite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, propertyId: propId })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(data.action === 'added' ? "‚ù§Ô∏è Added to Favorites" : "üíî Removed from Favorites");
                    myFavorites = data.favorites; // Sync list
                } else {
                    // Revert UI if server failed
                    btn.classList.toggle('active'); 
                }
            } catch (e) { console.error(e); }
        }

        function updateHeartIcons() {
            // Finds all heart buttons and colors them if they are in 'myFavorites'
            document.querySelectorAll('.fav-btn').forEach(btn => {
                const id = btn.dataset.id;
                const icon = btn.querySelector('i');
                if (myFavorites.includes(id)) {
                    btn.classList.add('active');
                    icon.classList.remove('fa-regular');
                    icon.classList.add('fa-solid');
                } else {
                    btn.classList.remove('active');
                    icon.classList.add('fa-regular');
                    icon.classList.remove('fa-solid');
                }
            });
        }

        // --- SKELETON LOADER FUNCTION ---
        function showSkeletons(containerId, count = 3) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let html = '';
            for(let i = 0; i < count; i++) {
                html += `
                <div class="sk-card">
                    <div class="skeleton sk-img"></div>
                    <div class="sk-info">
                        <div class="skeleton sk-line"></div>
                        <div class="skeleton sk-line-sm"></div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        // --- TOAST NOTIFICATION FUNCTION ---
        function showToast(message, type = "success") {
            // Choose color: Green for success, Red for error
            const bg = type === "success" 
                ? "linear-gradient(to right, #00b09b, #96c93d)" // Green
                : "linear-gradient(to right, #ff5f6d, #ffc371)"; // Red

            Toastify({
                text: message,
                duration: 3000,      // Disappears after 3 seconds
                close: true,         // Show 'x' close button
                gravity: "top",      // Show at the top
                position: "right",   // Show on the right
                stopOnFocus: true,   // Pause timer if mouse hovers
                style: {
                    background: bg,
                    borderRadius: "10px",
                    boxShadow: "0 4px 15px rgba(0,0,0,0.2)"
                }
            }).showToast();
        }

        // 1. Tab Selection (Buy/Rent/Commercial)
        function setSearchTab(el, val) {
            // 1. Remove 'active' from ALL tabs
            document.querySelectorAll('.tab-item, .ft-btn').forEach(tab => tab.classList.remove('active'));

            // 2. Add 'active' to CLICKED tab
            el.classList.add('active');

            // Also activate its counterpart on the other page if it exists
            const otherTab = document.querySelector(`.tab-item[data-value="${val}"], .ft-btn[data-value="${val}"]`);
            if (otherTab && otherTab !== el) {
                otherTab.classList.add('active');
            }

            // Style is now handled by CSS, but we can force it if needed
            // el.style.borderBottom = "3px solid #ff4757"; 
            // el.style.opacity = "1";

            // 3. Update Logic
            activeFilters.listingType = val;
            console.log("Switched to:", val);
        }

        // 2. Chip Selection (Single Select Logic)
        function selectSingle(containerId, btn, value) {
            const container = document.getElementById(containerId);
            
            // UI: Remove 'selected' from all siblings, add to clicked
            container.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            btn.classList.add('selected');

            // LOGIC: Map the Container ID to the specific Filter Variable
            if (containerId.includes('look')) activeFilters.listingType = value;
            if (containerId.includes('prop')) activeFilters.propertyType = value;
            if (containerId.includes('furnish')) activeFilters.furnishing = value;
            if (containerId.includes('build')) activeFilters.buildingType = value;
            if (containerId.includes('park')) activeFilters.parking = value;

            console.log("Filter Updated:", activeFilters); // Debugging
        }

        // Map container ID to state variable
        function updateFilterState(id, val) {
            if(id.includes('prop')) activeFilters.propertyType = val;
            if(id.includes('furnish')) activeFilters.furnishing = val;
            if(id.includes('build')) activeFilters.buildingType = val;
            if(id.includes('park')) activeFilters.parking = val;
            if(id.includes('look')) activeFilters.listingType = val;
        }

        // 3. Slider Update
        function updateRangeLabel(id, val, pre, post) {
            document.getElementById(id).innerText = val == 0 ? "Any" : pre + Number(val).toLocaleString() + post;
            if (id === 'disp-price') activeFilters.price = val;
            if (id === 'disp-sqft') activeFilters.sqft = val;
        }

        // --- LOADING HELPERS ---
            function showLoading(msg = "Please wait...") {
                document.getElementById('loading-msg').innerText = msg;
                document.getElementById('loading-overlay').classList.remove('hidden');
            }
            function hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            }

        // --- NAVIGATION LOGIC ---
        function goHome() {
            // Hide App Sections
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            
            // Show Home with Animation
            const home = document.getElementById('home-page');
            home.classList.remove('hidden');
            home.classList.add('animate-view'); // <--- Animate Home
            
            loadFeatured();
        }

        // --- REPLACE YOUR EXISTING showAuth FUNCTION WITH THIS ---
        // REPLACE your existing handleAuth function with this one
        // --- REPLACE YOUR EXISTING showAuth FUNCTION WITH THIS ---
        function showAuth(type) {
            console.log("showAuth called for:", type); // Debugging line
            currentUserType = type; // 'owner' or 'tenant'

            // 1. Hide ALL Sections first
            const sections = ['home-page', 'property-page', 'app-section', 'owner-section', 'tenant-section', 'auth-section', 'admin-dashboard'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });

            // 2. Decide what to show
            const token = localStorage.getItem('token');
            const savedType = localStorage.getItem('type'); // Get 'owner' or 'tenant' from DB
            
            // Always show the App Container (Parent of auth-section)
            const appSection = document.getElementById('app-section');
            appSection.classList.remove('hidden');
            appSection.classList.add('animate-view'); 

            // 3. CHECK: Are we logged in AND is the account type correct?
            if (token && savedType === type) {
                
                // --- LOGGED IN & CORRECT ROLE -> GO TO DASHBOARD ---
                if (type === 'owner') {
                    document.getElementById('owner-section').classList.remove('hidden');
                    if(typeof initOwnerMap === 'function') initOwnerMap();
                    if(typeof loadMyListings === 'function') loadMyListings();
                } else { 
                    // Tenant
                    document.getElementById('tenant-section').classList.remove('hidden');
                    if(typeof initTenantMap === 'function') initTenantMap();
                }

            } else {
                // --- NOT LOGGED IN (or Wrong Role) -> SHOW LOGIN FORM ---
                const authSection = document.getElementById('auth-section');
                authSection.classList.remove('hidden');
                authSection.classList.add('animate-view');
                
                // Reset the form state to "Login" (not Register)
                isLoginMode = true;
                document.getElementById('signup-fields').classList.add('hidden');
                document.getElementById('switch-text').innerText = "New here? Create Account";
                document.getElementById('auth-btn').innerText = "Login";

                // Custom Title
                const title = document.getElementById('auth-title');
                if(type === 'owner') {
                    title.innerText = "Owner Login";
                    title.style.color = "#e67e22"; // Orange
                } else {
                    title.innerText = "Tenant Login";
                    title.style.color = "#6C63FF"; // Purple
                }
            }
        }

        function triggerTenantSearch() {
            const homeInput = document.getElementById('home-search-input');
            const term = homeInput ? homeInput.value : '';

            if(!term) {
                alert("Please enter an area name");
                return;
            }

            // Switch to Tenant View
            showAuth('tenant'); 

            // Transfer text to BOTH potential tenant inputs
            const tenantInput1 = document.getElementById('search-query');
            const tenantInput2 = document.getElementById('f-loc');
            
            if(tenantInput1) tenantInput1.value = term;
            if(tenantInput2) tenantInput2.value = term;

            // Clear the home input so it doesn't interfere later
            if(homeInput) homeInput.value = '';

            // Run search
            searchProperties();
        }

        function closePropertyPage() {
            document.getElementById('property-page').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }

        // --- AUTH & TOGGLE ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "Create Account";
            document.getElementById('signup-fields').classList.toggle('hidden');
            document.getElementById('switch-text').innerText = isLoginMode ? "New here? Create Account" : "Already have an account? Login";
        }

        async function handleAuth() {
            // 1. Get Inputs
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            
            // 2. Validate
            if(!email || !email.includes('@')) return alert("Please enter a valid email");
            if(!password) return alert("Please enter password");

            const endpoint = isLoginMode ? '/login' : '/register';
            
            // 3. Build Payload
            // CRITICAL: We must send the currentUserType ('owner' or 'tenant') 
            // so the backend knows what role to assign/check.
            let payload = { email, password, userType: currentUserType };
            
            if(!isLoginMode) { 
                payload.firstName = document.getElementById('reg-name').value;
                payload.phone = document.getElementById('reg-phone').value;
                if(!payload.firstName) return alert("Enter Name");
            }

            try {
                showLoading(isLoginMode ? "Logging in..." : "Creating Account...");
                
                const res = await fetch(`${API_URL}${endpoint}`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                });
                
                const data = await res.json();
                
                if(data.success) { 
                    showToast("‚úÖ Successfully Logged In!", "success");
                    // SUCCESS: Save credentials
                    localStorage.setItem('token', data.token); 
                    
                    // IMPORTANT: Save the role and type correctly
                    localStorage.setItem('role', data.role || 'user');
                    localStorage.setItem('type', currentUserType); // Force save the type we just used
                    localStorage.setItem('email', email);
                    if(data.userType) {
                        localStorage.setItem('type', data.userType); 
                    }
                    // Redirect
                    checkSession(); 
                } else { 
                    showToast("‚ùå " + data.message, "error"); // <--- REPLACE
                    // FAILURE: Show error and STOP 
                    // Do NOT call checkSession() here
                }
            } catch(e) { 
                console.error(e); // See exact error in console
                alert("Connection Error. Check console for details."); 
            } 
            finally { hideLoading(); }
        }

        function checkSession() {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role'); // 'admin' or 'user'
            const type = localStorage.getItem('type'); // 'owner' or 'tenant' (from DB)
            
            if(token) {
                // Hide Home/Auth
                document.getElementById('home-page').classList.add('hidden');
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                 
                // 1. ADMIN CHECK
                if (role === 'admin') {
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    document.getElementById('app-section').classList.add('hidden');
                    loadAdminData();
                    return;
                } 
                
                // 2. SHOW APP SECTION
                document.getElementById('app-section').classList.remove('hidden');

                // 3. OWNER VS TENANT CHECK (Based on DB data)
                // Note: The value saved in DB is usually "Owner" or "Tenant" (capitalized) 
                // or whatever you typed in the dropdown during registration.
                // Let's handle case-insensitivity just to be safe.
                
                if(type && type.toLowerCase() === 'owner') {
                    // Force Owner View
                    document.getElementById('owner-section').classList.remove('hidden');
                    document.getElementById('tenant-section').classList.add('hidden'); // Ensure Tenant is hidden
                    initOwnerMap();
                    loadMyListings();
                } else {
                    // Default to Tenant View
                    document.getElementById('tenant-section').classList.remove('hidden');
                    document.getElementById('owner-section').classList.add('hidden'); // Ensure Owner is hidden
                    initTenantMap();
                }
                refreshFavorites();
            } else { 
                goHome(); 
            }
        }
        function handleLogout() { localStorage.clear(); location.reload(); }

        // --- UPLOAD ---
        async function uploadFile(inputId) {
            const fileInput = document.getElementById(inputId);
            if(!fileInput || fileInput.files.length === 0) return "";
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                return data.secure_url;
            } catch(e) { return ""; }
        }

        // --- OWNER FUNCTIONS ---
        function initOwnerMap() {
            if(ownerMap) return;
            ownerMap = L.map('owner-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ownerMap);
            ownerMap.on('click', e => {
                selectedLat = e.latlng.lat; selectedLng = e.latlng.lng;
                if(ownerMarker) ownerMap.removeLayer(ownerMarker);
                ownerMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(ownerMap);
                document.getElementById('coords-display').style.display = 'block';
            });
            setTimeout(() => ownerMap.invalidateSize(), 500);
        }

        async function searchOwnerMap() {
            const q = document.getElementById('owner-map-search').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}, Chennai`);
            const data = await res.json();
            if(data.length > 0) ownerMap.setView([data[0].lat, data[0].lon], 14);
        }

        async function submitListing() {
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerText;
            btn.innerText = "Processing..."; 
            btn.disabled = true;
            
            // Show Loading Spinner (if available)
            if(typeof showLoading === "function") showLoading("Saving changes...");

            try {
                // 1. Upload Images
                const [newOuter, newHall, newBed, newKitchen, newBath] = await Promise.all([
                    uploadFile('img-outer'),
                    uploadFile('img-hall'),
                    uploadFile('img-bed'),
                    uploadFile('img-kitchen'),
                    uploadFile('img-bath')
                ]);

                // 2. Merge Images safely
                const finalImages = {
                    outer: newOuter || (currentImages && currentImages.outer) || "",
                    hall: newHall || (currentImages && currentImages.hall) || "",
                    bedroom: newBed || (currentImages && currentImages.bedroom) || "",
                    kitchen: newKitchen || (currentImages && currentImages.kitchen) || "",
                    bathroom: newBath || (currentImages && currentImages.bathroom) || ""
                };

                // 3. Get Amenities (Safe Mode)
                const amenities = [];
                const checkboxes = document.querySelectorAll('.amenity-chk:checked');
                if(checkboxes) {
                    checkboxes.forEach(c => amenities.push(c.value));
                }

                // 4. Helper to get value safely
                const val = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : "";
                };

                // 5. Build Form Data (CORRECTED IDs)
                const form = {
                    ownerEmail: localStorage.getItem('email'),
                    firstName: document.getElementById('fname').value,
                    phone: document.getElementById('phone').value,
                    houseNo: document.getElementById('house').value,
                    street: val('house'), 
                    area: document.getElementById('area').value,
                    city: document.getElementById('city').value,
                    price: document.getElementById('price').value,
                    sqft: document.getElementById('sqft').value, 
                    bedrooms: document.getElementById('beds').value,
                    bathrooms: document.getElementById('baths').value,
                    furnishing: document.getElementById('o-furnish').value,
                    // ‚úÖ FIXED THESE TWO LINES:
                    listingType: document.getElementById('o-listingType').value, // Was 'o-listType'
                    parking: document.getElementById('o-parking').value,         // Was 'o-park'
                    propertyType: document.getElementById('o-propType').value,
                    buildingType: document.getElementById('o-buildType').value,
                    description: document.getElementById('desc').value,
                    amenities: amenities,
                    images: finalImages,
                    lat: selectedLat, 
                    lng: selectedLng
                };

                // 6. Basic Validation
                if(!form.firstName || !form.price) {
                    throw new Error("Please fill required fields (Name, Price)");
                }
                
                // Only enforce Map Pin if creating NEW, not updating
                if(!isEditing && (!form.lat || !form.lng)) {
                    throw new Error("Please Pin Location on Map");
                }

                // 7. Send to Server
                let endpoint = '/list-property';
                let method = 'POST';

                if (isEditing && editingId) {
                    endpoint = `/update-property/${editingId}`;
                    method = 'PUT';
                }

                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: method, 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(form)
                });
                
                const result = await res.json();
                
                if(result.success) {
                    showToast("üéâ Property Listed Successfully!", "success");
                    cancelEdit(); // Reset form
                    loadMyListings(); // Refresh list without reloading page
                    document.getElementById('my-listings-body').scrollIntoView({behavior: "smooth"});
                } else {
                    throw new Error(result.error || "Server rejected request");
                }

            } catch(e) {
                console.error(e);
                alert("Error saving: " + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
                if(typeof hideLoading === "function") hideLoading();
            }
        }
        function editProp(id) {
            // 1. Debugging: Check if we have the data
            console.log("Editing ID:", id);
            console.log("All Properties:", allMyProperties);

            // 2. Find the property in our global list
            // We use .find() to look through the array we saved in loadMyListings()
            const p = allMyProperties.find(prop => prop._id === id);
            
            if (!p) {
                alert("Error: Property data not found. Please refresh and try again.");
                return;
            }

            // 3. Fill Text Fields (Safety Checks added)
            // We use || "" to make sure we don't put "undefined" in the box
            document.getElementById('fname').value = p.firstName || "";
            document.getElementById('phone').value = p.phone || "";
            document.getElementById('house').value = p.houseNo || "";
            document.getElementById('street').value = p.street || "";
            document.getElementById('area').value = p.area || "";
            document.getElementById('city').value = p.city || "Chennai";
            document.getElementById('price').value = p.price || "";
            document.getElementById('sqft').value = p.sqft || "";
            
            // Dropdowns need to match the <option> values exactly
            document.getElementById('beds').value = p.bedrooms || ""; 
            document.getElementById('baths').value = p.bathrooms || "";
            document.getElementById('furnish').value = p.furnishing || "";
            document.getElementById('desc').value = p.description || "";
            document.getElementById('o-listingType').value = p.listingType || "Rent";
            document.getElementById('o-propType').value = p.propertyType || "Apartment";
            document.getElementById('o-buildType').value = p.buildingType || "Independent";
            document.getElementById('o-parking').value = p.parking || "Reserved";    
            // 4. Handle Images (The "No File Chosen" Fix)
            // We cannot set the file input. We must show the PREVIEW instead.
            currentImages = p.images || {}; 
            
            // Helper list to loop through all 5 types
            ['outer', 'hall', 'bed', 'kitchen', 'bath'].forEach(type => {
                // Handle naming differences (e.g., 'bed' vs 'bedroom')
                let dbKey = type;
                if(type === 'bed') dbKey = 'bedroom';
                if(type === 'bath') dbKey = 'bathroom';

                const url = currentImages[dbKey];
                const previewBox = document.getElementById(`preview-${type}`);
                
                if (url) {
                    // If we have an image, SHOW the preview box
                    previewBox.style.display = 'block';
                    previewBox.querySelector('img').src = url;
                } else {
                    // If no image, hide the preview
                    previewBox.style.display = 'none';
                }
            });

            // 5. Handle Amenities Checkboxes
            // Reset all first
            document.querySelectorAll('.amenity-chk').forEach(chk => chk.checked = false);
            // Check the ones saved in DB
            if (p.amenities) {
                p.amenities.forEach(am => {
                    // Find the checkbox with this value and check it
                    const chk = document.querySelector(`.amenity-chk[value="${am}"]`);
                    if(chk) chk.checked = true;
                });
            }

            // 6. Set Map Location
            selectedLat = p.lat; 
            selectedLng = p.lng;
            if(ownerMarker) ownerMap.removeLayer(ownerMarker);
            if(p.lat && p.lng) {
                ownerMarker = L.marker([p.lat, p.lng]).addTo(ownerMap);
                ownerMap.setView([p.lat, p.lng], 14);
            }

            // 7. Toggle UI to Edit Mode
            isEditing = true; 
            editingId = id;
            document.getElementById('form-title').innerText = "‚úèÔ∏è Edit Listing";
            document.getElementById('submit-btn').innerText = "Update Listing";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            // Scroll up to the form
            document.getElementById('listing-form-card').scrollIntoView({behavior:"smooth"});
        }
        function cancelEdit() {
            isEditing = false; editingId = null;
            document.querySelectorAll('#listing-form-card input, textarea').forEach(i => i.value = '');
            document.getElementById('form-title').innerText = "List New Property";
            document.getElementById('submit-btn').innerText = "Submit Listing";
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        async function loadMyListings() {
            const res = await fetch(`${API_URL}/my-properties?email=${localStorage.getItem('email')}`);
            const data = await res.json();
            
            // SAVE DATA GLOBALLY
            allMyProperties = data.properties;

            document.getElementById('my-listings-body').innerHTML = data.properties.map(p => `
                <tr>
                    <td><b>${p.area}</b></td>
                    <td><span class="status-badge">${p.status || 'Pending'}</span></td>
                    <td>
                        <button class="btn-sm bg-orange btn-edit" data-id="${p._id}">Edit</button>
                        <button class="btn-sm bg-red btn-delete" data-id="${p._id}">Del</button>
                    </td>
                </tr>
            `).join('');
        }
        // --- DELETE FUNCTION ---
        async function delProp(id) {
            // 1. Debugging: Check if ID is received
            console.log("Clicking delete for ID:", id);
            
            if (!id || id === 'undefined') {
                return alert("Error: Invalid Property ID. Please refresh.");
            }

            // 2. Confirmation
            if(!confirm("Are you sure you want to delete this listing permanently?")) return;

            // 3. Send Request
            try {
                const res = await fetch(`${API_URL}/delete-property/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    showToast("üóëÔ∏è Item Deleted", "success");
                    loadMyListings(); // Refresh the table
                } else {
                    alert("Server Error: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                showToast("‚ö†Ô∏è " + data.error, "error");
            }
        }
        // --- ADMIN DELETE FUNCTION ---
        async function deleteProp(id) {
            // 1. Confirm the action
            if(!confirm("‚ö†Ô∏è ADMIN ACTION: Are you sure you want to permanently delete this property?")) return;

            // 2. Show loading (optional)
            if(typeof showLoading === 'function') showLoading("Deleting...");

            try {
                // 3. Send Delete Request to Server
                const res = await fetch(`${API_URL}/delete-property/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                // 4. Handle Response
                if (data.success) {
                    showToast("üóëÔ∏è Item Deleted", "success");
                    loadAdminData(); // IMPORTANT: Refresh the Admin Table
                } else {
                    showToast("‚ö†Ô∏è " + data.error, "error");
                }
            } catch (e) {
                console.error(e);
                alert("Network Error: Could not reach server.");
            } finally {
                if(typeof hideLoading === 'function') hideLoading();
            }
        }


        // --- TENANT FUNCTIONS ---
        function initTenantMap() {
            const mapContainer = document.getElementById('tenant-map');
            if (!mapContainer) return; // Safety check: exit if the map container element doesn't exist

            const resizeMap = () => {
                // This function will be called to resize the map.
                // Using a timeout ensures this runs after the current JS execution stack is clear,
                // giving the browser a chance to paint layout changes.
                setTimeout(() => {
                    if (tenantMap) {
                        tenantMap.invalidateSize();
                    }
                }, 150); // A short delay is usually sufficient.
            };

            // If the map instance already exists, we just need to tell it to resize.
            if (tenantMap) {
                resizeMap();
                return;
            }

            // If it's the first time, create the map.
            tenantMap = L.map(mapContainer).setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(tenantMap);

            // After creating the map, we still need to resize it because its container was likely hidden.
            resizeMap();
        }

        async function searchProperties() {
            showToast("üîç Searching...", "info");
            
            // 1. GET THE RIGHT SEARCH TEXT
            // We check the "Sidebar Input" (f-loc) AND "Top Bar Input" (search-query)
            // We prioritize the one that actually has text in it.
            const sidebarInput = document.getElementById('f-loc');
            const topbarInput = document.getElementById('search-query');
            const homeInput = document.getElementById('home-search-input');
            
            let q = '';

            if (sidebarInput && sidebarInput.value.trim() !== '') {
                q = sidebarInput.value;
            } else if (topbarInput && topbarInput.value.trim() !== '') {
                q = topbarInput.value;
            } else if (homeInput && homeInput.value.trim() !== '') {
                // Only use Home Input if we are ON the Home Page
                if(!document.getElementById('home-page').classList.contains('hidden')) {
                    q = homeInput.value;
                }
            }

            console.log("Searching for:", q); // Debugging: Check console to see what it grabbed

            // 2. BUILD URL
            let url = `${API_URL}/search-properties?query=${q}`;
            
            // Add Filters (if they exist)
            if(typeof activeFilters !== 'undefined') {
                if(activeFilters.listingType) url += `&listingType=${activeFilters.listingType}`;
                if(activeFilters.propertyType) url += `&propertyType=${activeFilters.propertyType}`;
                if(activeFilters.price > 0) url += `&maxPrice=${activeFilters.price}`;
                if(activeFilters.sqft > 0) url += `&maxSqft=${activeFilters.sqft}`;
                if(activeFilters.furnishing) url += `&furnishing=${activeFilters.furnishing}`;
                if(activeFilters.parking) url += `&parking=${activeFilters.parking}`;
                if(activeFilters.buildingType) url += `&buildingType=${activeFilters.buildingType}`;
            }

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                // Clear Map
                if (tenantMap) {
                    tenantMap.eachLayer(l => { if(l instanceof L.Marker) tenantMap.removeLayer(l); });
                }

                if(data.properties.length > 0) {
                     // Move map to first result
                     if(tenantMap && data.properties[0].lat) {
                         tenantMap.setView([data.properties[0].lat, data.properties[0].lng], 14);
                     }
                     
                     data.properties.forEach(p => { 
                         if(tenantMap && p.lat) {
                             const m = L.marker([p.lat, p.lng]).addTo(tenantMap);
                             m.on('click', () => openPropertyPage(p)); 
                         }
                     });
                     
                     // Mobile Alert
                     if(window.innerWidth < 768) alert(`Found ${data.properties.length} properties!`);
                } else { 
                    alert("No properties found for '" + q + "'"); 
                }
            } catch(e) { console.error(e); } 
            finally { if(typeof hideLoading === 'function') hideLoading(); }
        }
        // --- UPDATE THIS FUNCTION ---
        function openPropertyPage(p) {
            // 1. SECURITY CHECK
            const token = localStorage.getItem('token');
            if (!token) {
                showToast("üîí Please Login to view property details", "error");
                showAuth('tenant'); // Force Login
                return; // Stop!
            }
            // 1. Hide ALL view sections (Home, App, Favorites, etc.)
            const views = ['app-section', 'favorites-section', 'home-page', 'tenant-section', 'owner-section'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });

            // 2. Show the Property Page
            const page = document.getElementById('property-page');
            page.classList.remove('hidden');
            window.scrollTo(0,0);

            // 3. Fill Data
            document.getElementById('dt-title').innerText = `${p.bedrooms || 2} BHK in ${p.area}`;
            document.getElementById('dt-addr').innerText = `üìç ${p.houseNo || ''}, ${p.area}, ${p.city}`;
            document.getElementById('dt-price').innerText = Number(p.price).toLocaleString();
            document.getElementById('dt-owner').innerText = p.firstName;
            document.getElementById('dt-sqft').innerText = p.sqft || '-';
            document.getElementById('dt-beds').innerText = p.bedrooms || '-';
            document.getElementById('dt-baths').innerText = p.bathrooms || '-';
            document.getElementById('dt-furnish').innerText = p.furnishing || '-';
            document.getElementById('dt-desc').innerText = p.description || "";
            
            // Links
            document.getElementById('dt-call').href = `tel:${p.phone}`;
            const msg = `Hi ${p.firstName}, I saw your ${p.bedrooms} BHK in ${p.area} on EstatePro. Is it available?`;
            document.getElementById('dt-wa').href = `https://wa.me/91${p.phone}?text=${encodeURIComponent(msg)}`;
            
            // Images
            const i = p.images || {};
            const def = 'https://via.placeholder.com/800x600?text=No+Image';
            document.getElementById('dt-img-1').src = i.outer || (p.imageUrl || def);
            document.getElementById('dt-img-2').src = i.hall || def;
            document.getElementById('dt-img-3').src = i.bedroom || def;
            document.getElementById('dt-img-4').src = i.kitchen || def;
            document.getElementById('dt-img-5').src = i.bathroom || def;
            
            // Mobile Images
            document.getElementById('m-img-1').src = i.outer || (p.imageUrl || def);
            document.getElementById('m-img-2').src = i.hall || def;
            document.getElementById('m-img-3').src = i.bedroom || def;
            document.getElementById('m-img-4').src = i.kitchen || def;
            document.getElementById('m-img-5').src = i.bathroom || def;

            // Amenities
            const am = document.getElementById('dt-amenities'); 
            am.innerHTML = '';
            if(p.amenities) p.amenities.forEach(a => am.innerHTML += `<span class="amenity-tag">‚úÖ ${a}</span>`);

            // Map logic
            if(detailMap) detailMap.remove();
            detailMap = L.map('detail-map').setView([p.lat || 13.0827, p.lng || 80.2707], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
            if(p.lat && p.lng) L.marker([p.lat, p.lng]).addTo(detailMap);

            setTimeout(() => { if (detailMap) detailMap.invalidateSize(); }, 150);
        }

        // --- HOME PAGE LOGIC ---
        async function loadFeatured() {
            try {
                showSkeletons('featured-list', 3); 

                const res = await fetch(`${API_URL}/featured-properties`);
                const data = await res.json();
                
                document.getElementById('featured-list').innerHTML = data.properties.map(p => {
                    const img = (p.images && p.images.outer) ? p.images.outer : 'https://via.placeholder.com/300x200';
                    
                    // Clean the JSON string for the onclick handler
                    const safeProp = JSON.stringify(p).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                    return `
                    <div class="prop-card" style="position:relative;">
                        
                        <div class="fav-btn" onclick="toggleFav(this, '${p._id}', event)">
                            <i class="fa-regular fa-heart"></i>
                        </div>

                        <div style="cursor:pointer;" onclick='openPropertyPage(${safeProp})'>
                            <img src="${img}" class="prop-img">
                            <div class="prop-info">
                                <h3 style="margin:0; color:var(--primary);">‚Çπ ${Number(p.price).toLocaleString()}</h3>
                                <p style="color:#666;">${p.bedrooms || 2} BHK in ${p.area}</p>
                            </div>
                        </div>

                    </div>`;
                }).join('');
                
                updateHeartIcons();

            } catch(e) { console.error(e); }
        }

        // --- EMI ---
        function calculateEMI() {
            const P = document.getElementById('loan-amount').value;
            if(!P) return;
            const R = 8.5/12/100; const N = 240;
            const emi = P * R * (Math.pow(1+R, N) / (Math.pow(1+R, N)-1));
            document.getElementById('emi-val').innerText = "‚Çπ " + Math.round(emi).toLocaleString();
        }

        function openLightbox(src) {
            // Only open if it's a valid image link
            if(src && src.includes('http')) {
                document.getElementById('lightbox-img').src = src;
                document.getElementById('lightbox').classList.remove('hidden');
                // Ensure it's visible by forcing display style
                document.getElementById('lightbox').style.display = 'flex';
            }
        }

        function closeLightbox() { 
            document.getElementById('lightbox').classList.add('hidden'); 
            document.getElementById('lightbox').style.display = 'none';
        }

        function updateAuthUI() {
            document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "Create Account";
            document.getElementById('signup-fields').classList.toggle('hidden', isLoginMode);
            document.getElementById('switch-text').innerText = isLoginMode ? "New here? Create Account" : "Already have an account? Login";
            document.getElementById('auth-btn').innerText = isLoginMode ? "Login" : "Create Account";
        }

        function setupEventListeners() {
            // --- Navigation ---
            document.getElementById('logo').addEventListener('click', goHome);
            document.getElementById('nav-home').addEventListener('click', goHome);
            document.getElementById('nav-list-property').addEventListener('click', () => showAuth('owner'));
            document.getElementById('nav-login').addEventListener('click', () => {
                // Check if user is already logged in
                const token = localStorage.getItem('token');
                
                if (token) {
                    // If logged in, let checkSession() decide where to go (Admin, Owner, or Tenant)
                    checkSession();
                } else {
                    // If NOT logged in, show the standard login form
                    showAuth('tenant');
                }
            });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // --- Home Page Search ---
            document.getElementById('hero-filter-btn').addEventListener('click', toggleFilter);
            document.getElementById('hero-search-btn').addEventListener('click', triggerTenantSearch);
            document.querySelector('.search-tabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-item')) {
                    setSearchTab(e.target, e.target.dataset.value);
                }
            });

            // --- Auth Page ---
            document.getElementById('auth-btn').addEventListener('click', handleAuth);
            document.getElementById('switch-text').addEventListener('click', toggleAuthMode);
            document.getElementById('auth-back-home').addEventListener('click', goHome);

            // --- Owner Dashboard ---
            document.getElementById('refresh-listings-btn').addEventListener('click', loadMyListings);
            document.getElementById('submit-btn').addEventListener('click', submitListing);
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
            document.getElementById('owner-map-search-btn').addEventListener('click', searchOwnerMap);

            // Event Delegation for "My Listings" table
            document.getElementById('my-listings-body').addEventListener('click', (e) => {
                const target = e.target.closest('button'); // Find the button that was clicked
                if (!target) return;

                const id = target.dataset.id;
                if (target.classList.contains('btn-edit')) {
                    editProp(id);
                } else if (target.classList.contains('btn-delete')) {
                    delProp(id);
                }
            });

            // Event Delegation for Image Removal
            document.querySelector('.upload-grid').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-remove-img')) {
                    const previewBox = e.target.closest('.img-preview-box');
                    if (previewBox && previewBox.dataset.type) {
                        deleteSpecificImage(previewBox.dataset.type);
                    }
                }
            });

            // --- Tenant/Search Page ---
            document.getElementById('tenant-search-btn').addEventListener('click', searchProperties);
            document.getElementById('tenant-back-btn').addEventListener('click', goHome);
            document.querySelector('.filter-tabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('ft-btn')) {
                    setSearchTab(e.target, e.target.dataset.value);
                }
            });

            // --- Property Detail Page ---
            document.getElementById('property-page-back-btn').addEventListener('click', closePropertyPage);

            // --- Modals (Lightbox & Filter) ---
            document.getElementById('lightbox').addEventListener('click', closeLightbox);
            document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
            document.getElementById('filter-modal-close').addEventListener('click', toggleFilter);
            document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
        }

        function deleteSpecificImage(type) {
            // 1. Remove from our memory
            currentImages[type] = ""; 
            
            // 2. Hide from UI
            document.getElementById(`preview-${type}`).style.display = 'none';
            
            // 3. Clear the file input (in case they selected something then deleted it)
            document.getElementById(`img-${type}`).value = "";
        }
        function toggleFilter() {
            document.getElementById('filter-modal').classList.toggle('hidden');
        }

        function selectOpt(groupId, el, value) {
            const group = document.getElementById(groupId);

            // Check if we are clicking the same button to "Unselect" it
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                // Reset that specific filter
                if(groupId === 'f-listing') searchFilters.listingType = '';
                if(groupId === 'f-prop') searchFilters.propertyType = '';
                return;
            }

            // Otherwise, select the new one
            group.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            if(groupId === 'f-listing') searchFilters.listingType = value;
            if(groupId === 'f-prop') searchFilters.propertyType = value;
        }

        function updateRange(id, val, pre='', post='') {
            document.getElementById(id).innerText = val == 0 ? "Any" : pre + Number(val).toLocaleString() + post;
            if(id === 'price-val') searchFilters.price = val;
            if(id === 'sqft-val') searchFilters.sqft = val;
        }

        function applyFilters() {
            toggleFilter(); // Close modal
            showAuth('tenant'); // Go to tenant view
            // Trigger search immediately
            setTimeout(searchProperties, 500); 
        }
        // --- ADMIN FUNCTIONS ---
        async function loadAdminData() {
            try {
                const res = await fetch(`${API_URL}/admin/all-properties`);
                const data = await res.json();
                
                // 1. Update Text Stats
                document.getElementById('stat-users').innerText = data.stats.users;
                document.getElementById('stat-props').innerText = data.stats.listings;

                // 2. Populate Table
                const tbody = document.getElementById('admin-table-body');
                tbody.innerHTML = data.properties.map(p => {
                    const img = (p.images && p.images.outer) ? `<img src="${p.images.outer}" width="50" style="border-radius:4px;">` : 'No Img';
                    const verifyBtn = p.isVerified 
                        ? `<span class="status-badge" style="background:#def7ec; color:green;">Verified</span>` 
                        : `<button class="btn-sm bg-orange" onclick="verifyProp('${p._id}')">Verify</button>`;
                    
                    return `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;">${img}</td>
                        <td>
                            <b>${p.area}</b><br>
                            <span style="font-size:12px; color:#666;">${p.listingType} ‚Ä¢ ‚Çπ${p.price}</span>
                        </td>
                        <td>${p.firstName}<br><small>${p.ownerEmail}</small></td>
                        <td>${verifyBtn}</td>
                        <td><button style="color:red; background:none; border:none; cursor:pointer;" onclick="deleteProp('${p._id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                }).join('');

                // 3. DRAW CHART (New Logic)
                const rentCount = data.properties.filter(p => p.listingType === 'Rent').length;
                const buyCount = data.properties.filter(p => p.listingType === 'Buy').length;

                const ctx = document.getElementById('listingChart').getContext('2d');
                
                // Destroy old chart if refreshing
                if(adminChart) adminChart.destroy();

                adminChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['For Rent', 'For Sale'],
                        datasets: [{
                            data: [rentCount, buyCount],
                            backgroundColor: ['#6C63FF', '#2A2A72'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

            } catch(e) { console.error(e); }
        }

        async function verifyProp(id) {
            if(!confirm("Verify this property?")) return;
            await fetch(`${API_URL}/admin/verify/${id}`, { method: 'PUT' });
            loadAdminData();
        }
        function checkPendingSearch() { 
            console.log("Search checked"); 
        }
        // Re-using your existing deleteProp function, make sure it calls loadAdminData() if admin
        // (You can just use the delete button to call deleteProp, it works for both)

        // INIT
        setupEventListeners();
        loadFeatured();
        checkSession();

    </script>
</body>
</html>