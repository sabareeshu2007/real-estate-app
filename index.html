<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatePro - Full Platform</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- PROFESSIONAL DESIGN VARIABLES --- */
        :root { 
            --primary: #6C63FF; 
            --secondary: #2A2A72; 
            --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); min-height: 100vh; color: #2d3436; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* NAV */
        nav { 
            background: var(--glass); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 24px; font-weight: 700; color: var(--secondary); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { text-decoration: none; color: #636e72; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .nav-links a:hover { color: var(--primary); }
        .btn-login { border: 2px solid var(--primary); color: var(--primary) !important; padding: 8px 25px; border-radius: 30px; font-weight: 600; }
        .btn-login:hover { background: var(--primary); color: white !important; }

        /* UTILS */
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; animation: fadeIn 0.8s ease; }
        .hidden { display: none !important; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
        
        /* INPUTS & BUTTONS */
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid #dfe6e9; border-radius: 10px; font-size: 14px; background: #f9f9f9; margin-bottom: 15px; }
        input:focus { outline: none; border-color: var(--primary); background: white; }
        
        .btn { padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s; text-align: center; display: block; text-decoration: none; }
        .btn-primary { background: linear-gradient(45deg, var(--secondary), var(--primary)); color: white; box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-outline { border: 1px solid var(--primary); background: transparent; color: var(--primary); }
        .btn-whatsapp { background: #25D366; color: white; }
        
        /* --- HOME PAGE SPECIFIC --- */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover; background-position: center; height: 500px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
        }
        .search-hero { background: white; padding: 10px; border-radius: 50px; display: flex; gap: 10px; width: 90%; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .search-hero input { border: none; background: transparent; margin: 0; padding: 10px 20px; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px; }
        .prop-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer; }
        .prop-card:hover { transform: translateY(-10px); }
        .prop-img { height: 200px; width: 100%; object-fit: cover; }
        .prop-info { padding: 20px; }

        .blog-card { border-left: 5px solid var(--primary); padding: 20px; }
        
        footer { background: var(--secondary); color: white; padding: 50px 10%; margin-top: 50px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; }
        footer a { color: #b2bec3; display: block; margin-bottom: 10px; font-size: 14px; text-decoration: none; }

        /* --- DASHBOARD SPECIFIC --- */
        .map-box { height: 350px; width: 100%; border-radius: 15px; border: 2px solid white; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; background: #f1f2f6; padding: 10px; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f1f2f6; font-size: 14px; }
        .status-badge { background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } 
        .full-width { grid-column: span 2; }
        
        /* IMAGE UPLOAD GRID */
        .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .upload-item { background: #f8f9fa; padding: 10px; border-radius: 10px; text-align: center; border: 1px dashed #ccc; }
        .upload-item label { font-size: 11px; font-weight: bold; display: block; margin-bottom: 5px; }
        .upload-item input { width: 100%; font-size: 10px; padding: 0; background: transparent; border: none; }

        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #f1f2f6; padding: 5px 10px; border-radius: 5px; }
        .checkbox-item input { width: auto; margin: 0; }

        .btn-sm { width: auto; padding: 5px 15px; font-size: 12px; display: inline-block; margin-right: 5px; border-radius: 5px; cursor: pointer; color: white; border: none; }
        .bg-orange { background: #f39c12; }
        .bg-red { background: #e74c3c; }

        /* --- PROPERTY DETAIL PAGE --- */
        .gallery-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 400px; margin-bottom: 30px; }
        .main-img { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; background: #ddd; }
        .side-imgs { display: flex; flex-direction: column; gap: 15px; }
        .sub-img { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; background: #eee; }
        
        .details-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; }
        .highlights { display: flex; gap: 20px; margin: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 20px 0; }
        .highlight-item { text-align: center; flex: 1; border-right: 1px solid #eee; font-size: 14px; }
        .highlight-item i { font-size: 20px; color: var(--primary); margin-bottom: 5px; }
        
        .amenity-tag { background: #e3f2fd; color: var(--primary); padding: 8px 15px; border-radius: 20px; font-size: 13px; display: inline-block; margin: 5px; }
        
        .price-card { position: sticky; top: 100px; border: 1px solid #eee; }
        .emi-box { background: #e3f2fd; padding: 20px; border-radius: 15px; margin-top: 30px; }

        @media (max-width: 768px) { 
            .form-grid, .details-layout, .gallery-grid { grid-template-columns: 1fr; } 
            .side-imgs { display: none; } 
            .full-width { grid-column: span 1; }
            .gallery-grid { height: 250px; }
        }
        /* --- NEW STYLES FOR MOBILE & LIGHTBOX --- */
        
        /* 1. Lightbox (Full Screen Zoom) */
        #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; 
            display: flex; justify-content: center; align-items: center;
        }
        #lightbox img { max-width: 95%; max-height: 80vh; border-radius: 5px; }
        .close-lb { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; }

        /* 2. Gallery Layouts */
        .gallery-desktop { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; height: 400px; }
        .gallery-right { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; }
        .gal-img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; border-radius: 10px; transition:0.2s; }
        .gal-img:hover { opacity: 0.9; }

        .gallery-mobile { display: none; } /* Hidden on Desktop */

        /* 3. Mobile Responsiveness */
        /* --- MOBILE FIXES --- */
        @media (max-width: 768px) {
            /* Fix Navigation */
            nav { padding: 15px; flex-direction: column; gap: 10px; }
            .nav-links { width: 100%; justify-content: center; gap: 15px; }
            .logo { margin-bottom: 5px; }

            /* Fix Gallery */
            .gallery-desktop { display: none; }
            .gallery-mobile { 
                display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scroll-snap-type: x mandatory; 
            }
            .gallery-mobile img { 
                width: 85vw; height: 250px; object-fit: cover; border-radius: 10px; flex-shrink: 0; scroll-snap-align: center; 
            }

            /* Fix Forms & Layout */
            .form-grid, .details-layout, .upload-grid { grid-template-columns: 1fr !important; }
            .full-width { grid-column: span 1 !important; }
            
            /* Fix Search Bar */
            .search-wrapper { flex-direction: column; padding: 15px; border-radius: 20px; }
            .search-wrapper input, .search-wrapper select, .search-wrapper button { width: 100%; border-radius: 10px; margin-bottom: 5px; }
            
            /* Fix Property Page */
            .highlights { flex-wrap: wrap; gap: 10px; }
            .highlight-item { flex: 1 1 40%; margin-bottom: 10px; }
            .price-card { position: static; margin-top: 20px; }
        }
            /* --- LOADING SPINNER CSS --- */
            #loading-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(255, 255, 255, 0.9); z-index: 10000;
                display: flex; justify-content: center; align-items: center; flex-direction: column;
            }
            .spinner {
                width: 50px; height: 50px; border: 5px solid #e3e3e3;
                border-top: 5px solid var(--primary); border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            /* --- EDIT PHOTO STYLES --- */
            .img-preview-box { position: relative; margin-top: 5px; display: none; } /* Hidden by default */
            .img-preview-box img { width: 100%; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
            .btn-remove-img {
                position: absolute; top: -5px; right: -5px;
                background: red; color: white; border: none;
                border-radius: 50%; width: 20px; height: 20px;
                font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            }
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p id="loading-msg" style="margin-top:15px; font-weight:600; color:#666;">Processing...</p>
    </div>
    <div id="lightbox" class="hidden" onclick="closeLightbox()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column;">
        <span style="position:absolute; top:20px; right:30px; color:white; font-size:40px; cursor:pointer;">&times;</span>
        <img id="lightbox-img" src="" style="max-width:90%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(255,255,255,0.2);">
        <p style="color:#ccc; margin-top:10px;">Tap anywhere to close</p>
    </div>
    <div id="lightbox" class="hidden" onclick="this.classList.add('hidden')">
        <span class="close-lb">&times;</span>
        <img id="lightbox-img" src="">
    </div>

    <nav>
        <div class="logo" onclick="goHome()">üè† EstatePro</div>
        <div class="nav-links">
            <a onclick="goHome()">Home</a>
            <a onclick="showAuth('owner')">List Property</a>
            <a onclick="showAuth('tenant')" class="btn-login">Login</a>
        </div>
        <button id="logout-btn" class="hidden" style="margin-left:20px; background:none; border:none; color:red; cursor:pointer;" onclick="handleLogout()">Logout</button>
    </nav>

    <div id="home-page">
        <header class="hero">
            <h1>Find Your Dream Home in Chennai</h1>
            <p>Search properties for buy & rent</p>
            <div class="search-hero">
                <input type="text" id="home-search-input" placeholder="Area...">
                <select id="home-budget" style="border:none; padding:10px;">
                    <option value="">Budget</option>
                    <option value="5000000">Max 50L</option>
                    <option value="10000000">Max 1Cr</option>
                </select>
                <select id="home-bhk" style="border:none; padding:10px;">
                    <option value="">BHK</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
                <button class="btn-primary" onclick="triggerTenantSearch()" style="width:auto; padding:10px 20px; border-radius:40px;">Search</button>
            </div>
        </header>

        <div class="container">
            <h2 style="text-align:center; margin-top:50px;">Featured Properties</h2>
            <div class="grid-container" id="featured-list">
                <p style="text-align:center; width:100%;">Loading latest properties...</p>
            </div>

            <h2 style="text-align:center; margin-top:60px;">Latest Real Estate News</h2>
            <div class="grid-container">
                <div class="card blog-card">
                    <h4>üìà Top 5 Areas to Invest</h4>
                    <p style="font-size:12px; color:#999;">Oct 12, 2025</p>
                    <p>Anna Nagar and OMR are seeing highest appreciation...</p>
                </div>
                <div class="card blog-card">
                    <h4>üí∞ Home Loan Rates Drop</h4>
                    <p style="font-size:12px; color:#999;">Nov 01, 2025</p>
                    <p>New RBI policies make buying affordable...</p>
                </div>
                <div class="card blog-card">
                    <h4>üè° Interior Design Trends</h4>
                    <p style="font-size:12px; color:#999;">Nov 20, 2025</p>
                    <p>Minimalist designs are taking over in 2025...</p>
                </div>
            </div>
        </div>

        <footer>
            <div>
                <h4>EstatePro</h4>
                <p style="font-size:13px; opacity:0.8;">The #1 Real Estate platform in Chennai.</p>
            </div>
            <div>
                <h4>Company</h4>
                <a href="#">About Us</a>
                <a href="#">Careers</a>
                <a href="#">Contact</a>
            </div>
            <div>
                <h4>Legal</h4>
                <a href="#">Terms</a>
                <a href="#">Privacy</a>
            </div>
            <div>
                <h4>Social</h4>
                <a href="#">Facebook</a>
                <a href="#">Instagram</a>
            </div>
        </footer>
    </div>

    <div id="app-section" class="container hidden">
        
        <div id="auth-section" class="card" style="max-width:450px; margin:50px auto; text-align:center;">
            <h2 id="auth-title">Welcome Back</h2>
            
            <div id="signup-fields" class="hidden">
                <input type="text" id="reg-name" placeholder="Full Name">
                <input type="tel" id="reg-phone" placeholder="Phone Number">
            </div>

            <input type="email" id="email-input" placeholder="Email Address">
            <input type="password" id="pass-input" placeholder="Password">
            
            <button class="btn btn-primary" onclick="handleAuth()">Login</button>
            
            <div style="margin-top:20px; display:flex; justify-content:space-between; font-size:13px;">
                <span onclick="toggleAuthMode()" style="color:var(--primary); cursor:pointer; font-weight:600;" id="switch-text">New here? Create Account</span>
                <span onclick="goHome()" style="color:#666; cursor:pointer;">‚Üê Back to Home</span>
            </div>
        </div>

        <div id="owner-section" class="hidden">
            <div class="card">
                <h2>üìä My Listings</h2>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Property</th><th>Status</th><th>Actions</th></tr></thead><tbody id="my-listings-body"></tbody></table>
                </div>
                <button class="btn btn-primary" style="width:auto; margin-top:15px;" onclick="loadMyListings()">Refresh Status</button>
            </div>

            <div class="card" id="listing-form-card">
                <h2 id="form-title">üìç List New Property</h2>
                
                <div class="form-grid">
                    <input type="text" id="fname" placeholder="Owner Name">
                    <input type="tel" id="phone" placeholder="Contact Phone">
                    
                    <div class="full-width"><input type="text" id="house" placeholder="Full Address (House No, Street)"></div>
                    
                    <input type="text" id="area" placeholder="Area / Neighborhood">
                    <input type="text" id="city" value="Chennai">
                    
                    <input type="number" id="price" placeholder="Price (‚Çπ)">
                    <input type="number" id="sqft" placeholder="Size (Sq. Ft)">
                    
                    <select id="beds"><option value="">Bedrooms</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
                    <select id="baths"><option value="">Bathrooms</option><option>1</option><option>2</option><option>3</option></select>
                    
                    <div class="full-width">
                        <label>Furnishing:</label>
                        <select id="furnish"><option>Unfurnished</option><option>Semi-Furnished</option><option>Fully Furnished</option></select>
                    </div>
                    
                    <div class="full-width">
                        <label>Description:</label>
                        <textarea id="desc" rows="3" placeholder="Describe the property..."></textarea>
                    </div>

                    <div class="full-width">
                        <label>Upload / Manage Photos:</label>
                        <div class="upload-grid">
                            
                            <div class="upload-item">
                                <label>Outer</label>
                                <input type="file" id="img-outer">
                                <div id="preview-outer" class="img-preview-box">
                                    <img src="">
                                    <button class="btn-remove-img" onclick="deleteSpecificImage('outer')">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Hall</label>
                                <input type="file" id="img-hall">
                                <div id="preview-hall" class="img-preview-box">
                                    <img src="">
                                    <button class="btn-remove-img" onclick="deleteSpecificImage('hall')">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Bed</label>
                                <input type="file" id="img-bed">
                                <div id="preview-bed" class="img-preview-box">
                                    <img src="">
                                    <button class="btn-remove-img" onclick="deleteSpecificImage('bed')">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Kitchen</label>
                                <input type="file" id="img-kitchen">
                                <div id="preview-kitchen" class="img-preview-box">
                                    <img src="">
                                    <button class="btn-remove-img" onclick="deleteSpecificImage('kitchen')">√ó</button>
                                </div>
                            </div>

                            <div class="upload-item">
                                <label>Bath</label>
                                <input type="file" id="img-bath">
                                <div id="preview-bath" class="img-preview-box">
                                    <img src="">
                                    <button class="btn-remove-img" onclick="deleteSpecificImage('bath')">√ó</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <h4 style="margin-top:20px;">Amenities</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Lift"> Lift</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Gym"> Gym</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Parking"> Parking</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Security"> Security</div>
                    <div class="checkbox-item"><input type="checkbox" class="amenity-chk" value="Power Backup"> Power Backup</div>
                </div>

                <h4 style="margin-top:20px;">Pin Exact Location</h4>
                <div style="position:relative;">
                    <input type="text" id="owner-map-search" placeholder="Search Map (e.g. T Nagar)" style="position:absolute; top:10px; left:50px; z-index:999; width:200px;">
                    <button onclick="searchOwnerMap()" style="position:absolute; top:10px; left:260px; z-index:999; width:40px; padding:10px;">üîç</button>
                    <div id="owner-map" class="map-box"></div>
                </div>
                <p id="coords-display" style="text-align:center; color:green; display:none; margin-top:5px;">‚úÖ Location Pinned!</p>

                <button class="btn btn-primary" id="submit-btn" onclick="submitListing()" style="margin-top:20px;">Submit Listing</button>
                <button class="btn btn-outline hidden" id="cancel-edit-btn" onclick="cancelEdit()" style="margin-top:5px;">Cancel Edit</button>
            </div>
        </div>

        <div id="tenant-section" class="hidden">
            <div class="card">
                <h2>Find Homes</h2>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="search-query" placeholder="Search Area...">
                    <select id="search-budget">
                        <option value="">Budget</option>
                        <option value="5000000">Max 50L</option>
                        <option value="10000000">Max 1Cr</option>
                    </select>
                    <select id="search-bhk">
                        <option value="">BHK</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                    <button class="btn btn-primary" style="width:auto;" onclick="searchProperties()">üîç</button>
                </div>
            </div>
            <div class="card"><div id="tenant-map" class="map-box" style="height:500px;"></div></div>
        </div>
    </div>

    <div id="property-page" class="hidden">
        <div class="container">
            <button onclick="closePropertyPage()" style="background:none; border:none; cursor:pointer; margin-bottom:15px; font-size:16px;">‚Üê Back to Map</button>
            
            <div class="gallery-desktop">
                <img id="dt-img-1" class="gal-img" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
                <div class="gallery-right">
                    <img id="dt-img-2" class="gal-img" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <img id="dt-img-3" class="gal-img" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <img id="dt-img-4" class="gal-img" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <img id="dt-img-5" class="gal-img" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                </div>
            </div>
            
            <div class="gallery-mobile">
                <img id="m-img-1" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
                <img id="m-img-2" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <img id="m-img-3" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <img id="m-img-4" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <img id="m-img-5" onclick="openLightbox(this.src)" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
            </div>
            
            <div class="details-layout">
                <div class="main-content">
                    <h1 id="dt-title" style="margin:0;">Property Title</h1>
                    <p id="dt-addr" style="color:#666; margin-top:5px;">Address Location</p>
                    
                    <div class="highlights">
                        <div class="highlight-item"><i class="fas fa-ruler-combined"></i><br><b><span id="dt-sqft"></span></b> Sqft</div>
                        <div class="highlight-item"><i class="fas fa-bed"></i><br><b><span id="dt-beds"></span></b> Beds</div>
                        <div class="highlight-item"><i class="fas fa-bath"></i><br><b><span id="dt-baths"></span></b> Baths</div>
                        <div class="highlight-item"><i class="fas fa-couch"></i><br><b><span id="dt-furnish"></span></b></div>
                    </div>

                    <h3>Description</h3>
                    <p id="dt-desc" style="color:#555; line-height:1.6;"></p>

                    <h3>Amenities</h3>
                    <div id="dt-amenities" style="margin-bottom:30px;"></div>

                    <h3>Location</h3>
                    <div id="detail-map" class="map-box" style="height:250px;"></div>
                    <a id="dt-sv" href="#" target="_blank" class="btn btn-outline" style="margin-top:15px;">üëÄ Open 360¬∞ Street View</a>

                    <div class="emi-box">
                        <h3 style="margin-top:0;">EMI Calculator</h3>
                        <input type="number" id="loan-amount" placeholder="Loan Amount (e.g. 5000000)" oninput="calculateEMI()">
                        <div style="text-align:center; font-size:20px; font-weight:700; color:var(--primary); margin-top:10px;">Monthly EMI: <span id="emi-val">‚Çπ 0</span></div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="card price-card">
                        <div style="font-size:32px; font-weight:700; color:var(--secondary);">‚Çπ <span id="dt-price"></span></div>
                        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                        <h4>Owner Details</h4>
                        <p style="font-size:18px; font-weight:600;"><span id="dt-owner"></span></p>
                        <a id="dt-call" href="#" class="btn btn-primary"><i class="fas fa-phone"></i> Call Now</a>
                        <a id="dt-wa" href="#" target="_blank" class="btn btn-whatsapp" style="margin-top:10px;"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                    </div>
                    
                    <div class="card">
                        <h4>Nearby Essentials</h4>
                        <ul style="padding-left:20px; line-height:2; color:#666;">
                            <li>üè´ School: 0.5 km</li>
                            <li>üè• Hospital: 1.2 km</li>
                            <li>üöÜ Metro: 2.0 km</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // ‚ö†Ô∏è REPLACE WITH YOUR RENDER URL
        const API_URL = 'https://real-estate-app-925m.onrender.com/api'; // REPLACE
        const CLOUD_NAME = 'dfsotxfxg';      // REPLACE
        const UPLOAD_PRESET = 'estate'; // REPLACE 

        let currentUserType = 'owner';
        let ownerMap, tenantMap, detailMap; 
        let selectedLat, selectedLng, ownerMarker;
        let isLoginMode = true, isEditing = false, editingId = null;
        let currentImages = {}; // Stores the current photos while editing
        let allMyProperties = []; // Stores full property data

        // --- LOADING HELPERS ---
            function showLoading(msg = "Please wait...") {
                document.getElementById('loading-msg').innerText = msg;
                document.getElementById('loading-overlay').classList.remove('hidden');
            }
            function hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            }

        // --- NAVIGATION LOGIC ---
        function goHome() {
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('property-page').classList.add('hidden');
            loadFeatured();
        }

        function showAuth(type) {
            currentUserType = type;
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('owner-section').classList.add('hidden');
            document.getElementById('tenant-section').classList.add('hidden');
        }

        function triggerTenantSearch() {
            const q = document.getElementById('home-search-input').value;
            const price = document.getElementById('home-budget').value;
            const bhk = document.getElementById('home-bhk').value;
            
            showAuth('tenant');
            // Save filters as a JSON string
            localStorage.setItem('pendingSearch', JSON.stringify({q, price, bhk}));
        }

        function closePropertyPage() {
            document.getElementById('property-page').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }

        // --- AUTH & TOGGLE ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "Create Account";
            document.getElementById('signup-fields').classList.toggle('hidden');
            document.getElementById('switch-text').innerText = isLoginMode ? "New here? Create Account" : "Already have an account? Login";
        }

        async function handleAuth() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            const endpoint = isLoginMode ? '/login' : '/register';
            let payload = { email, password, userType: currentUserType };
            
            if(!isLoginMode) {
                payload.firstName = document.getElementById('reg-name').value;
                payload.phone = document.getElementById('reg-phone').value;
                if(!payload.firstName) return alert("Fill Name");
            }

            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('type', currentUserType);
                    localStorage.setItem('email', email);
                    checkSession();
                } else { alert(data.message); }
            } catch(e) { alert("Error"); }
        }

        function checkSession() {
            if(localStorage.getItem('token')) {
                document.getElementById('home-page').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.querySelector('.nav-links').classList.add('hidden');

                if(localStorage.getItem('type') === 'owner') {
                    document.getElementById('owner-section').classList.remove('hidden');
                    initOwnerMap();
                    loadMyListings();
                } else {
                    document.getElementById('tenant-section').classList.remove('hidden');
                    initTenantMap();
                    const pending = localStorage.getItem('pendingSearch');
                    if(pending) {
                        // Parse the JSON object
                        try {
                            const {q, price, bhk} = JSON.parse(pending);
                            document.getElementById('search-query').value = q || '';
                            document.getElementById('search-budget').value = price || '';
                            document.getElementById('search-bhk').value = bhk || '';
                            setTimeout(searchProperties, 1000);
                        } catch(e) {
                            // Fallback for old string searches
                            document.getElementById('search-query').value = pending;
                        }
                        localStorage.removeItem('pendingSearch');
                    }
                }
            } else { goHome(); }
        }
        function handleLogout() { localStorage.clear(); location.reload(); }

        // --- UPLOAD ---
        async function uploadFile(inputId) {
            const fileInput = document.getElementById(inputId);
            if(!fileInput || fileInput.files.length === 0) return "";
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                return data.secure_url;
            } catch(e) { return ""; }
        }

        // --- OWNER FUNCTIONS ---
        function initOwnerMap() {
            if(ownerMap) return;
            ownerMap = L.map('owner-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ownerMap);
            ownerMap.on('click', e => {
                selectedLat = e.latlng.lat; selectedLng = e.latlng.lng;
                if(ownerMarker) ownerMap.removeLayer(ownerMarker);
                ownerMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(ownerMap);
                document.getElementById('coords-display').style.display = 'block';
            });
            setTimeout(() => ownerMap.invalidateSize(), 500);
        }

        async function searchOwnerMap() {
            const q = document.getElementById('owner-map-search').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}, Chennai`);
            const data = await res.json();
            if(data.length > 0) ownerMap.setView([data[0].lat, data[0].lon], 14);
        }

        async function submitListing() {
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerText;
            btn.innerText = "Processing..."; 
            btn.disabled = true;
            
            // Show Loading Spinner (if available)
            if(typeof showLoading === "function") showLoading("Saving changes...");

            try {
                // 1. Upload Images
                const [newOuter, newHall, newBed, newKitchen, newBath] = await Promise.all([
                    uploadFile('img-outer'),
                    uploadFile('img-hall'),
                    uploadFile('img-bed'),
                    uploadFile('img-kitchen'),
                    uploadFile('img-bath')
                ]);

                // 2. Merge Images safely
                const finalImages = {
                    outer: newOuter || (currentImages && currentImages.outer) || "",
                    hall: newHall || (currentImages && currentImages.hall) || "",
                    bedroom: newBed || (currentImages && currentImages.bedroom) || "",
                    kitchen: newKitchen || (currentImages && currentImages.kitchen) || "",
                    bathroom: newBath || (currentImages && currentImages.bathroom) || ""
                };

                // 3. Get Amenities (Safe Mode)
                const amenities = [];
                const checkboxes = document.querySelectorAll('.amenity-chk:checked');
                if(checkboxes) {
                    checkboxes.forEach(c => amenities.push(c.value));
                }

                // 4. Helper to get value safely
                const val = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : "";
                };

                // 5. Build Form Data
                const form = {
                    ownerEmail: localStorage.getItem('email'),
                    firstName: val('fname'),
                    phone: val('phone'),
                    houseNo: val('house'),
                    street: val('house'), // fallback if street input missing
                    area: val('area'),
                    city: val('city'),
                    price: val('price'),
                    sqft: val('sqft'),
                    bedrooms: val('beds'),
                    bathrooms: val('baths'),
                    furnishing: val('furnish'),
                    description: val('desc'),
                    amenities: amenities,
                    images: finalImages,
                    lat: selectedLat, 
                    lng: selectedLng
                };

                // 6. Basic Validation
                if(!form.firstName || !form.price) {
                    throw new Error("Please fill required fields (Name, Price)");
                }
                
                // Only enforce Map Pin if creating NEW, not updating
                if(!isEditing && (!form.lat || !form.lng)) {
                    throw new Error("Please Pin Location on Map");
                }

                // 7. Send to Server
                let endpoint = '/list-property';
                let method = 'POST';

                if (isEditing && editingId) {
                    endpoint = `/update-property/${editingId}`;
                    method = 'PUT';
                }

                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: method, 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(form)
                });
                
                const result = await res.json();
                
                if(result.success) {
                    alert("Success! Saved successfully.");
                    location.reload(); 
                } else {
                    throw new Error(result.error || "Server rejected request");
                }

            } catch(e) {
                console.error(e);
                alert("Error saving: " + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
                if(typeof hideLoading === "function") hideLoading();
            }
        }
        function editProp(id) {
            // 1. Debugging: Check if we have the data
            console.log("Editing ID:", id);
            console.log("All Properties:", allMyProperties);

            // 2. Find the property in our global list
            // We use .find() to look through the array we saved in loadMyListings()
            const p = allMyProperties.find(prop => prop._id === id);
            
            if (!p) {
                alert("Error: Property data not found. Please refresh and try again.");
                return;
            }

            // 3. Fill Text Fields (Safety Checks added)
            // We use || "" to make sure we don't put "undefined" in the box
            document.getElementById('fname').value = p.firstName || "";
            document.getElementById('phone').value = p.phone || "";
            document.getElementById('house').value = p.houseNo || "";
            document.getElementById('street').value = p.street || "";
            document.getElementById('area').value = p.area || "";
            document.getElementById('city').value = p.city || "Chennai";
            document.getElementById('price').value = p.price || "";
            document.getElementById('sqft').value = p.sqft || "";
            
            // Dropdowns need to match the <option> values exactly
            document.getElementById('beds').value = p.bedrooms || "";
            document.getElementById('baths').value = p.bathrooms || "";
            document.getElementById('furnish').value = p.furnishing || "";
            document.getElementById('desc').value = p.description || "";

            // 4. Handle Images (The "No File Chosen" Fix)
            // We cannot set the file input. We must show the PREVIEW instead.
            currentImages = p.images || {}; 
            
            // Helper list to loop through all 5 types
            ['outer', 'hall', 'bed', 'kitchen', 'bath'].forEach(type => {
                // Handle naming differences (e.g., 'bed' vs 'bedroom')
                let dbKey = type;
                if(type === 'bed') dbKey = 'bedroom';
                if(type === 'bath') dbKey = 'bathroom';

                const url = currentImages[dbKey];
                const previewBox = document.getElementById(`preview-${type}`);
                
                if (url) {
                    // If we have an image, SHOW the preview box
                    previewBox.style.display = 'block';
                    previewBox.querySelector('img').src = url;
                } else {
                    // If no image, hide the preview
                    previewBox.style.display = 'none';
                }
            });

            // 5. Handle Amenities Checkboxes
            // Reset all first
            document.querySelectorAll('.amenity-chk').forEach(chk => chk.checked = false);
            // Check the ones saved in DB
            if (p.amenities) {
                p.amenities.forEach(am => {
                    // Find the checkbox with this value and check it
                    const chk = document.querySelector(`.amenity-chk[value="${am}"]`);
                    if(chk) chk.checked = true;
                });
            }

            // 6. Set Map Location
            selectedLat = p.lat; 
            selectedLng = p.lng;
            if(ownerMarker) ownerMap.removeLayer(ownerMarker);
            if(p.lat && p.lng) {
                ownerMarker = L.marker([p.lat, p.lng]).addTo(ownerMap);
                ownerMap.setView([p.lat, p.lng], 14);
            }

            // 7. Toggle UI to Edit Mode
            isEditing = true; 
            editingId = id;
            document.getElementById('form-title').innerText = "‚úèÔ∏è Edit Listing";
            document.getElementById('submit-btn').innerText = "Update Listing";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            // Scroll up to the form
            document.getElementById('listing-form-card').scrollIntoView({behavior:"smooth"});
        }
        function cancelEdit() {
            isEditing = false; editingId = null;
            document.querySelectorAll('#listing-form-card input, textarea').forEach(i => i.value = '');
            document.getElementById('form-title').innerText = "List New Property";
            document.getElementById('submit-btn').innerText = "Submit Listing";
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        async function loadMyListings() {
            const res = await fetch(`${API_URL}/my-properties?email=${localStorage.getItem('email')}`);
            const data = await res.json();
            
            // SAVE DATA GLOBALLY
            allMyProperties = data.properties;

            document.getElementById('my-listings-body').innerHTML = data.properties.map(p => `
                <tr>
                    <td><b>${p.area}</b></td>
                    <td>${p.status}</td>
                    <td>
                        <button class="btn-sm bg-orange" onclick="editProp('${p._id}')">Edit</button>
                        <button class="btn-sm bg-red" onclick="delProp('${p._id}')">Del</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- TENANT FUNCTIONS ---
        function initTenantMap() {
            if(tenantMap) return;
            tenantMap = L.map('tenant-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(tenantMap);
            setTimeout(() => tenantMap.invalidateSize(), 500);
        }

        async function searchProperties() {
            showLoading("Searching properties..."); // START
            
            try {
                const q = document.getElementById('search-query').value;
                const price = document.getElementById('search-budget').value;
                const bhk = document.getElementById('search-bhk').value;
                
                const res = await fetch(`${API_URL}/search-properties?query=${q}&maxPrice=${price}&bhk=${bhk}`);
                const data = await res.json();
                
                tenantMap.eachLayer(l => { if(l instanceof L.Marker) tenantMap.removeLayer(l); });
                
                if(data.properties.length > 0) {
                    tenantMap.setView([data.properties[0].lat, data.properties[0].lng], 14);
                    data.properties.forEach(p => { 
                        const m = L.marker([p.lat, p.lng]).addTo(tenantMap);
                        m.on('click', () => openPropertyPage(p)); 
                    });
                } else { alert("No listings match your filters."); }
                
            } catch(e) { alert("Search failed"); }
            finally { hideLoading(); } // STOP (Always runs)
        }

        // --- PROPERTY PAGE LOGIC ---
        function openPropertyPage(p) {
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('property-page').classList.remove('hidden');
            window.scrollTo(0,0);

            document.getElementById('dt-title').innerText = `${p.bedrooms || 2} BHK in ${p.area}`;
            document.getElementById('dt-addr').innerText = `üìç ${p.houseNo || ''}, ${p.area}, ${p.city}`;
            document.getElementById('dt-price').innerText = Number(p.price).toLocaleString();
            document.getElementById('dt-owner').innerText = p.firstName;
            document.getElementById('dt-sqft').innerText = p.sqft || '-';
            document.getElementById('dt-beds').innerText = p.bedrooms || '-';
            document.getElementById('dt-baths').innerText = p.baths || '-';
            document.getElementById('dt-desc').innerText = p.description || "";
            document.getElementById('dt-call').href = `tel:${p.phone}`;
            const message = `Hi ${p.firstName}, I saw your ${p.bedrooms || 2} BHK property in ${p.area} listed on EstatePro for ‚Çπ${Number(p.price).toLocaleString()}. Is it still available?`;
            const encodedMsg = encodeURIComponent(message);
            document.getElementById('dt-wa').href = `https://wa.me/91${p.phone}?text=${encodedMsg}`;
            document.getElementById('dt-sv').href = `https://www.google.com/maps?layer=c&cbll=${p.lat},${p.lng}`;

            // --- NEW 5-IMAGE LOGIC (PASTED HERE) ---
            const i = p.images || {};
            const def = 'https://via.placeholder.com/800x600?text=No+Image';

            // Fill Desktop Grid
            document.getElementById('dt-img-1').src = i.outer || (p.imageUrl || def);
            document.getElementById('dt-img-2').src = i.hall || def;
            document.getElementById('dt-img-3').src = i.bedroom || def;
            document.getElementById('dt-img-4').src = i.kitchen || def;
            document.getElementById('dt-img-5').src = i.bathroom || def;

            // Fill Mobile Scroll
            document.getElementById('m-img-1').src = i.outer || (p.imageUrl || def);
            document.getElementById('m-img-2').src = i.hall || def;
            document.getElementById('m-img-3').src = i.bedroom || def;
            document.getElementById('m-img-4').src = i.kitchen || def;
            document.getElementById('m-img-5').src = i.bathroom || def;
            // ---------------------------------------

            const am = document.getElementById('dt-amenities'); am.innerHTML = '';
            if(p.amenities) p.amenities.forEach(a => am.innerHTML += `<span class="amenity-tag">‚úÖ ${a}</span>`);

            if(detailMap) detailMap.remove();
            detailMap = L.map('detail-map').setView([p.lat, p.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
            L.marker([p.lat, p.lng]).addTo(detailMap);
        }

        // --- HOME PAGE LOGIC ---
        async function loadFeatured() {
            try {
                const res = await fetch(`${API_URL}/featured-properties`);
                const data = await res.json();
                document.getElementById('featured-list').innerHTML = data.properties.map(p => {
                    const img = (p.images && p.images.outer) ? p.images.outer : (p.imageUrl || 'https://via.placeholder.com/300x200');
                    return `<div class="prop-card" onclick="showAuth('tenant')">
                        <img src="${img}" class="prop-img">
                        <div class="prop-info">
                            <h3 style="margin:0; color:var(--primary);">‚Çπ ${Number(p.price).toLocaleString()}</h3>
                            <p style="color:#666;">${p.bedrooms || 2} BHK in ${p.area}</p>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {}
        }

        // --- EMI ---
        function calculateEMI() {
            const P = document.getElementById('loan-amount').value;
            if(!P) return;
            const R = 8.5/12/100; const N = 240;
            const emi = P * R * (Math.pow(1+R, N) / (Math.pow(1+R, N)-1));
            document.getElementById('emi-val').innerText = "‚Çπ " + Math.round(emi).toLocaleString();
        }
        function openLight(src) {
            if(src) {
                document.getElementById('lightbox-img').src = src;
                document.getElementById('lightbox').classList.remove('hidden');
            }
        }
        // --- LIGHTBOX FUNCTIONS ---
        function openLightbox(src) {
            // Only open if it's a valid image link
            if(src && src.includes('http')) {
                document.getElementById('lightbox-img').src = src;
                document.getElementById('lightbox').classList.remove('hidden');
                // Ensure it's visible by forcing display style
                document.getElementById('lightbox').style.display = 'flex';
            }
        }

        function closeLightbox() { 
            document.getElementById('lightbox').classList.add('hidden'); 
            document.getElementById('lightbox').style.display = 'none';
        }

        function deleteSpecificImage(type) {
            // 1. Remove from our memory
            currentImages[type] = ""; 
            
            // 2. Hide from UI
            document.getElementById(`preview-${type}`).style.display = 'none';
            
            // 3. Clear the file input (in case they selected something then deleted it)
            document.getElementById(`img-${type}`).value = "";
        }

        // INIT
        loadFeatured();
        checkSession();

    </script>
</body>
</html>