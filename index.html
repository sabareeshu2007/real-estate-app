<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatePro - Street View</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #6C63FF; --secondary: #2A2A72; --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; }
        
        nav { background: rgba(255,255,255,0.95); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo { font-weight: 700; font-size: 20px; color: var(--secondary); }
        .nav-btn { border: 2px solid var(--primary); color: var(--primary); padding: 8px 20px; border-radius: 30px; background: transparent; cursor: pointer; font-weight: 600; }
        
        .container { max-width: 1000px; margin: 40px auto; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .hidden { display: none !important; }

        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #dfe6e9; border-radius: 10px; box-sizing: border-box; }
        button.primary { background: linear-gradient(45deg, var(--secondary), var(--primary)); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        label { font-size: 12px; font-weight: 600; color: #636e72; }
        
        .map-box { height: 350px; width: 100%; border-radius: 15px; border: 2px solid white; margin-top: 10px; }
        .popup-img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }

        /* Street View Button Style */
        .street-view-btn {
            display: inline-block; background: #4285F4; color: white; 
            padding: 6px 12px; border-radius: 4px; text-decoration: none; 
            font-size: 12px; font-weight: bold; margin-top: 8px; width: 100%; text-align: center;
        }
        .street-view-btn:hover { background: #3367D6; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; background: #f1f2f6; padding: 10px; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f1f2f6; font-size: 14px; }
        .status-badge { background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">üè† EstatePro</div>
        <div id="nav-buttons">
            <button class="nav-btn" onclick="showLogin('owner')">Owner Portal</button>
            <button class="nav-btn" onclick="showLogin('tenant')">Find Home</button>
        </div>
        <button id="logout-btn" class="nav-btn hidden" onclick="handleLogout()">Logout</button>
    </nav>

    <div id="auth-section" class="container">
        <div class="card" style="max-width:400px; margin:50px auto; text-align:center;">
            <h2 id="auth-title">Welcome</h2>
            <input type="email" id="email-input" placeholder="Email Address">
            <input type="password" id="pass-input" placeholder="Password">
            <button class="primary" onclick="handleLogin()">Continue</button>
        </div>
    </div>

    <div id="owner-section" class="container hidden">
        <div class="card">
            <h2>üìä My Listings</h2>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Photo</th><th>Property</th><th>Status</th><th>AI Check</th></tr></thead>
                    <tbody id="my-listings-body"></tbody>
                </table>
            </div>
            <button class="nav-btn" style="margin-top:10px; font-size:12px;" onclick="loadMyListings()">Refresh Status</button>
        </div>

        <div class="card">
            <h2>üìç List New Property</h2>
            <div class="form-grid">
                <div><label>First Name</label><input type="text" id="fname"></div>
                <div><label>Phone</label><input type="tel" id="phone"></div>
                <div class="full-width"><label>Address (House, Street)</label><input type="text" id="house"></div>
                <div><label>Area / Neighborhood</label><input type="text" id="area"></div>
                <div><label>City</label><input type="text" id="city" value="Chennai"></div>
                <div class="full-width">
                    <label>Property Photo</label>
                    <input type="file" id="prop-image" accept="image/*">
                </div>
            </div>

            <h4 style="margin-top:20px;">Pin Location</h4>
            <div id="owner-map" class="map-box"></div>
            <p id="coords-display" style="text-align:center; color:green; display:none;">‚úÖ Location Pinned!</p>

            <button class="primary" id="submit-btn" onclick="submitListing()">Submit Listing</button>
        </div>
    </div>

    <div id="tenant-section" class="container hidden">
        <div class="card">
            <h2>Find Homes</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="search-query" placeholder="Search Area or Street">
                <button class="primary" style="width:auto; margin-top:0;" onclick="searchProperties()">Search</button>
            </div>
        </div>
        <div class="card" style="padding:10px;">
            <div id="tenant-map" class="map-box" style="height:500px;"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'https://real-estate-app-925m.onrender.com/api'; // REPLACE WITH RENDER URL
        
        // --- CLOUDINARY CONFIG (REPLACE THESE) ---
        const CLOUD_NAME = 'YOUR_CLOUD_NAME'; 
        const UPLOAD_PRESET = 'YOUR_UPLOAD_PRESET'; 

        let currentUserType = 'owner';
        let ownerMap, tenantMap, selectedLat, selectedLng, ownerMarker;

        // --- AUTH ---
        function showLogin(type) {
            currentUserType = type;
            document.getElementById('auth-title').innerText = type + ' Login';
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('owner-section').classList.add('hidden');
            document.getElementById('tenant-section').classList.add('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password, userType: currentUserType })
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('email', email);
                    localStorage.setItem('type', currentUserType);
                    checkSession();
                } else { alert(data.message); }
            } catch(e) { alert("Connection Error"); }
        }

        function checkSession() {
            if(localStorage.getItem('token')) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('nav-buttons').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                if(localStorage.getItem('type') === 'owner') {
                    document.getElementById('owner-section').classList.remove('hidden');
                    initOwnerMap();
                    loadMyListings();
                } else {
                    document.getElementById('tenant-section').classList.remove('hidden');
                    initTenantMap();
                }
            }
        }
        function handleLogout() { localStorage.clear(); location.reload(); }

        async function uploadImage() {
            const fileInput = document.getElementById('prop-image');
            if(fileInput.files.length === 0) return null;
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST', body: formData
                });
                const data = await res.json();
                return data.secure_url;
            } catch(e) { console.error(e); return null; }
        }

        // --- OWNER ---
        function initOwnerMap() {
            if(ownerMap) return;
            ownerMap = L.map('owner-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ownerMap);
            ownerMap.on('click', e => {
                selectedLat = e.latlng.lat; selectedLng = e.latlng.lng;
                if(ownerMarker) ownerMap.removeLayer(ownerMarker);
                ownerMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(ownerMap);
                document.getElementById('coords-display').style.display = 'block';
            });
            setTimeout(() => ownerMap.invalidateSize(), 500);
        }

        async function submitListing() {
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Uploading..."; btn.disabled = true;

            const imgUrl = await uploadImage();
            
            const form = {
                ownerEmail: localStorage.getItem('email'),
                firstName: document.getElementById('fname').value,
                phone: document.getElementById('phone').value,
                houseNo: document.getElementById('house').value,
                street: document.getElementById('house').value,
                area: document.getElementById('area').value,
                city: document.getElementById('city').value,
                lat: selectedLat, lng: selectedLng,
                imageUrl: imgUrl
            };

            if(!form.firstName || !form.area || !form.lat) {
                btn.innerText = "Submit"; btn.disabled = false;
                return alert("Fill details & Pin Map!");
            }
            
            await fetch(`${API_URL}/list-property`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form)
            });
            alert("Success!");
            location.reload();
        }

        async function loadMyListings() {
            const res = await fetch(`${API_URL}/my-properties?email=${localStorage.getItem('email')}`);
            const data = await res.json();
            const tbody = document.getElementById('my-listings-body');
            tbody.innerHTML = '';
            data.properties.forEach(p => {
                const imgDisplay = p.imageUrl ? `<img src="${p.imageUrl}" width="50" style="border-radius:5px;">` : 'No Img';
                tbody.innerHTML += `<tr>
                    <td>${imgDisplay}</td>
                    <td><b>${p.area}</b></td>
                    <td><span class="status-badge">${p.status}</span></td>
                    <td>${p.lastChecked ? new Date(p.lastChecked).toLocaleTimeString() : 'Pending'}</td>
                </tr>`;
            });
        }

        // --- TENANT (WITH STREET VIEW) ---
        function initTenantMap() {
            if(tenantMap) return;
            tenantMap = L.map('tenant-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(tenantMap);
            setTimeout(() => tenantMap.invalidateSize(), 500);
        }

        async function searchProperties() {
            const q = document.getElementById('search-query').value;
            // Fetch data
            const res = await fetch(`${API_URL}/search-properties?query=${q}`);
            const data = await res.json();
            
            // 1. Clear OLD markers safely
            if(tenantMap) {
                tenantMap.eachLayer(layer => { 
                    if(layer instanceof L.Marker) tenantMap.removeLayer(layer); 
                });
            }

            if(data.properties.length > 0) {
                 // 2. Center map on the first valid result
                 const validProp = data.properties.find(p => p.lat && p.lng);
                 if(validProp) {
                     tenantMap.setView([validProp.lat, validProp.lng], 14);
                 }

                 let count = 0;

                 data.properties.forEach(p => {
                     // 3. SAFETY CHECK: Only draw if coordinates exist (Fixes crash)
                     if(p.lat && p.lng) {
                         count++;
                         
                         const imgHtml = p.imageUrl ? `<img src="${p.imageUrl}" class="popup-img">` : '';
                         
                         // 4. FIX: Correct Google Maps Link Syntax
                         const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`;

                         // 5. Add Marker & Popup
                         L.marker([p.lat, p.lng]).addTo(tenantMap)
                          .bindPopup(`
                            <div style="min-width:200px;">
                                ${imgHtml}
                                <b>${p.area}</b><br>
                                ${p.street || 'Street not available'}<br>
                                <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                                üë§ ${p.firstName || 'Owner'}<br>
                                üìû <a href="tel:${p.phone}">${p.phone}</a><br>
                                <a href="${googleMapsLink}" target="_blank" class="street-view-btn" style="background:#4285F4; color:white; padding:5px 10px; text-decoration:none; display:block; margin-top:5px; text-align:center; border-radius:4px;">üìç Open in Google Maps</a>
                            </div>
                          `);
                     }
                 });
                 
                 if(count === 0) alert("Properties found, but none have map locations pinned yet.");
                 
            } else { 
                alert("No listings found matching that name."); 
            }
        }

        checkSession();
    </script>
</body>
</html>