<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatePro - Property Details</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #0984e3; --secondary: #2d3436; --accent: #00cec9; --bg: #f5f6fa; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg); color: var(--secondary); }
        
        /* NAVIGATION */
        nav { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: 700; color: var(--primary); cursor: pointer; }
        .nav-links a { margin-left: 20px; text-decoration: none; color: #636e72; font-weight: 500; cursor: pointer; }
        .btn-login { background: var(--primary); color: white !important; padding: 8px 20px; border-radius: 20px; }

        /* UTILS */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; width: 100%; display: block; text-align: center; text-decoration: none;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-whatsapp { background: #25D366; color: white; margin-top: 10px; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: white; margin-top: 10px; }
        
        /* --- PROPERTY PAGE STYLES --- */
        
        /* Gallery */
        .gallery-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; height: 400px; margin-bottom: 20px; }
        .main-img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; background: #ddd; }
        .side-imgs { display: flex; flex-direction: column; gap: 10px; }
        .sub-img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; background: #eee; }

        /* Layout Grid */
        .details-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        /* Highlights */
        .highlights { display: flex; gap: 20px; margin: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 20px 0; }
        .highlight-item { text-align: center; flex: 1; border-right: 1px solid #eee; }
        .highlight-item:last-child { border: none; }
        .highlight-item i { font-size: 24px; color: var(--primary); margin-bottom: 5px; }
        
        /* Amenities */
        .amenities-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .amenity { background: #f1f2f6; padding: 8px; border-radius: 5px; font-size: 13px; display: flex; align-items: center; gap: 5px; }

        /* Price Card (Sticky) */
        .price-card { position: sticky; top: 100px; border: 1px solid #eee; }
        .price-tag { font-size: 28px; font-weight: 700; color: #2d3436; margin-bottom: 5px; }

        /* EMI Calculator */
        .emi-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .emi-result { font-size: 20px; font-weight: 700; color: var(--primary); text-align: center; margin-top: 10px; }

        /* Maps */
        .mini-map { height: 250px; width: 100%; border-radius: 10px; margin-top: 20px; }

        /* Mobile */
        @media (max-width: 768px) {
            .gallery-grid { grid-template-columns: 1fr; height: 250px; }
            .side-imgs { display: none; }
            .details-layout { grid-template-columns: 1fr; }
            .highlights { flex-wrap: wrap; }
        }
        
        /* Existing Styles for Dashboard/Maps */
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #dfe6e9; border-radius: 8px; }
        .map-box { height: 400px; width: 100%; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; } th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

    <nav>
        <div class="logo" onclick="goHome()">üè† EstatePro</div>
        <div class="nav-links">
            <a onclick="goHome()">Home</a>
            <a onclick="showAuth('owner')">List Property</a>
            <a onclick="showAuth('tenant')" class="btn-login">Login</a>
        </div>
        <button id="logout-btn" class="hidden" style="margin-left:20px; background:none; border:none; color:red; cursor:pointer;" onclick="handleLogout()">Logout</button>
    </nav>

    <div id="home-page">
        <div style="background:linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80'); height:500px; background-size:cover; background-position:center; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center;">
            <h1 style="font-size:48px; margin-bottom:10px;">Find Your Place</h1>
            <button onclick="showAuth('tenant')" class="btn btn-primary" style="width:200px; margin-top:20px;">Start Searching</button>
        </div>
    </div>

    <div id="app-section" class="container hidden">
        
        <div id="auth-section" class="card" style="max-width:400px; margin:50px auto; text-align:center;">
            <h2>Welcome</h2>
            <input type="email" id="email-input" placeholder="Email">
            <input type="password" id="pass-input" placeholder="Password">
            <button class="btn btn-primary" onclick="handleLogin()">Login / Register</button>
        </div>

        <div id="owner-section" class="hidden">
            <div class="card">
                <h2>My Listings</h2>
                <table><tbody id="my-listings-body"></tbody></table>
                <button class="btn btn-outline" onclick="loadMyListings()">Refresh</button>
            </div>
            <div class="card">
                <h2>List New Property</h2>
                <input type="text" id="fname" placeholder="Name"><input type="tel" id="phone" placeholder="Phone">
                <input type="text" id="area" placeholder="Area"><input type="text" id="city" value="Chennai">
                <input type="text" id="house" placeholder="Full Address">
                <label>Photo:</label><input type="file" id="prop-image">
                <div id="owner-map" class="map-box"></div>
                <button class="btn btn-primary" id="submit-btn" onclick="submitListing()" style="margin-top:10px;">Submit</button>
            </div>
        </div>

        <div id="tenant-section" class="hidden">
            <div class="card">
                <h2>Search Homes</h2>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="search-query" placeholder="Search Area (e.g. Anna Nagar)">
                    <button class="btn btn-primary" style="width:auto; margin:0;" onclick="searchProperties()">Search</button>
                </div>
            </div>
            <div class="card"><div id="tenant-map" class="map-box"></div></div>
        </div>
    </div>

    <div id="property-page" class="hidden">
        <div class="container">
            <button onclick="closePropertyPage()" style="background:none; border:none; color:#666; cursor:pointer; margin-bottom:10px;">‚Üê Back to Search</button>
            
            <div class="gallery-grid">
                <img id="detail-img-main" src="" class="main-img">
                <div class="side-imgs">
                    <img src="https://via.placeholder.com/400x300/eee?text=Kitchen" class="sub-img">
                    <img src="https://via.placeholder.com/400x300/eee?text=Living+Room" class="sub-img">
                </div>
            </div>

            <div class="details-layout">
                <div class="main-content">
                    <h1 id="detail-title" style="margin:0;">3BHK Apartment</h1>
                    <p id="detail-address" style="color:#666;">üìç Anna Nagar, Chennai</p>
                    
                    <div class="highlights">
                        <div class="highlight-item"><i class="fas fa-ruler-combined"></i><br>1500 sqft</div>
                        <div class="highlight-item"><i class="fas fa-bed"></i><br>3 Beds</div>
                        <div class="highlight-item"><i class="fas fa-bath"></i><br>2 Baths</div>
                        <div class="highlight-item"><i class="fas fa-couch"></i><br>Furnished</div>
                    </div>

                    <h3>Description</h3>
                    <p style="color:#555; line-height:1.6;">
                        Beautiful property located in a prime area. Close to schools, hospitals, and metro stations. 
                        Perfect for families looking for a peaceful yet connected neighborhood.
                    </p>

                    <h3>Amenities</h3>
                    <div class="amenities-grid">
                        <div class="amenity"><i class="fas fa-check-circle" style="color:green"></i> Lift</div>
                        <div class="amenity"><i class="fas fa-check-circle" style="color:green"></i> Power Backup</div>
                        <div class="amenity"><i class="fas fa-check-circle" style="color:green"></i> CCTV</div>
                        <div class="amenity"><i class="fas fa-check-circle" style="color:green"></i> Gym</div>
                        <div class="amenity"><i class="fas fa-check-circle" style="color:green"></i> Parking</div>
                    </div>

                    <h3>Location Map</h3>
                    <div id="detail-map" class="mini-map"></div>
                    <a id="street-view-btn" href="#" target="_blank" class="btn btn-outline">üëÄ Open 360¬∞ Street View</a>

                    <div class="emi-box">
                        <h3>EMI Calculator</h3>
                        <input type="number" id="loan-amount" placeholder="Loan Amount (e.g. 5000000)" oninput="calculateEMI()">
                        <div class="emi-result">Monthly EMI: <span id="emi-val">‚Çπ 0</span></div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="card price-card">
                        <div class="price-tag">‚Çπ <span id="detail-price">75 Lakhs</span></div>
                        <p style="font-size:12px; color:#999;">EMI starts at ‚Çπ40k</p>
                        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                        
                        <h4>Owner Details</h4>
                        <p style="font-weight:600;" id="detail-owner">John Doe</p>
                        
                        <a id="btn-call" href="#" class="btn btn-primary"><i class="fas fa-phone"></i> Call Now</a>
                        <a id="btn-whatsapp" href="#" target="_blank" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                        <button class="btn btn-outline">Request Visit</button>
                    </div>
                    
                    <div class="card">
                        <h4>Nearby Essentials</h4>
                        <ul style="padding-left:20px; color:#555;">
                            <li>üè´ School: 0.5 km</li>
                            <li>üè• Hospital: 1.2 km</li>
                            <li>üöÜ Metro: 2.0 km</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_URL = 'https://real-estate-app-925m.onrender.com/api'; // REPLACE
        const CLOUD_NAME = 'dfsotxfxg';      // REPLACE
        const UPLOAD_PRESET = 'estate'; // REPLACE

        let currentUserType = 'owner';
        let ownerMap, tenantMap, detailMap; 
        let selectedLat, selectedLng, ownerMarker;

        // --- NAVIGATION ---
        function goHome() {
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('property-page').classList.add('hidden');
        }

        function showAuth(type) {
            currentUserType = type;
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('owner-section').classList.add('hidden');
            document.getElementById('tenant-section').classList.add('hidden');
        }

        function closePropertyPage() {
            document.getElementById('property-page').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }

        // --- AUTH & UPLOAD (Standard) ---
        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password, userType: currentUserType })
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('email', email);
                    localStorage.setItem('type', currentUserType);
                    checkSession();
                } else { alert(data.message); }
            } catch(e) { alert("Error"); }
        }

        function checkSession() {
            if(localStorage.getItem('token')) {
                document.getElementById('home-page').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                if(localStorage.getItem('type') === 'owner') {
                    document.getElementById('owner-section').classList.remove('hidden');
                    initOwnerMap();
                    loadMyListings();
                } else {
                    document.getElementById('tenant-section').classList.remove('hidden');
                    initTenantMap();
                }
            } else { goHome(); }
        }

        function handleLogout() { localStorage.clear(); location.reload(); }

        async function uploadImage() {
            const fileInput = document.getElementById('prop-image');
            if(fileInput.files.length === 0) return null;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                return data.secure_url;
            } catch(e) { return null; }
        }

        // --- OWNER LOGIC ---
        function initOwnerMap() {
            if(ownerMap) return;
            ownerMap = L.map('owner-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ownerMap);
            ownerMap.on('click', e => {
                selectedLat = e.latlng.lat; selectedLng = e.latlng.lng;
                if(ownerMarker) ownerMap.removeLayer(ownerMarker);
                ownerMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(ownerMap);
            });
            setTimeout(() => ownerMap.invalidateSize(), 500);
        }

        async function submitListing() {
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Processing..."; btn.disabled = true;
            let imgUrl = await uploadImage();
            const form = {
                ownerEmail: localStorage.getItem('email'),
                firstName: document.getElementById('fname').value,
                phone: document.getElementById('phone').value,
                houseNo: document.getElementById('house').value,
                street: document.getElementById('house').value,
                area: document.getElementById('area').value,
                city: document.getElementById('city').value,
                lat: selectedLat, lng: selectedLng
            };
            if(imgUrl) form.imageUrl = imgUrl;
            if(!form.firstName || !form.area || !form.lat) {
                btn.innerText = "Submit"; btn.disabled = false;
                return alert("Fill Details & Pin Map!");
            }
            await fetch(`${API_URL}/list-property`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form)
            });
            alert("Success!");
            location.reload();
        }

        async function loadMyListings() {
            const res = await fetch(`${API_URL}/my-properties?email=${localStorage.getItem('email')}`);
            const data = await res.json();
            document.getElementById('my-listings-body').innerHTML = data.properties.map(p => 
                `<tr><td>${p.area}</td><td>${p.status}</td><td>View</td></tr>`
            ).join('');
        }

        // --- TENANT SEARCH ---
        function initTenantMap() {
            if(tenantMap) return;
            tenantMap = L.map('tenant-map').setView([13.0827, 80.2707], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(tenantMap);
            setTimeout(() => tenantMap.invalidateSize(), 500);
        }

        async function searchProperties() {
            const q = document.getElementById('search-query').value;
            const res = await fetch(`${API_URL}/search-properties?query=${q}`);
            const data = await res.json();
            
            // Clear old markers
            tenantMap.eachLayer(l => { if(l instanceof L.Marker) tenantMap.removeLayer(l); });
            
            if(data.properties.length > 0) {
                 // Fly to the first result
                 tenantMap.setView([data.properties[0].lat, data.properties[0].lng], 14);
                 
                 data.properties.forEach(p => {
                     // 1. Prepare Image
                     const img = p.imageUrl ? `<img src="${p.imageUrl}" style="width:100%; height:120px; object-fit:cover; border-radius:5px; margin-bottom:5px;">` : '';
                     
                     // 2. Prepare Google Street View Link (Free Method)
                     const streetViewLink = `https://www.google.com/maps?layer=c&cbll=${p.lat},${p.lng}`;

                     // 3. Create Popup
                     L.marker([p.lat, p.lng]).addTo(tenantMap)
                      .bindPopup(`
                        ${img}
                        <div style="font-size:14px; line-height:1.5;">
                            <b>${p.area}</b><br>
                            ${p.street}<br>
                            Owner: ${p.firstName}<br>
                            <span style="color:green">üìû ${p.phone}</span>
                            <br>
                            <a href="${streetViewLink}" target="_blank" 
                               style="display:inline-block; margin-top:8px; background:#4285F4; color:white; padding:5px 10px; text-decoration:none; border-radius:4px; font-size:12px;">
                               üëÄ Open Street View 360¬∞
                            </a>
                        </div>
                      `);
                 });
            } else { alert("No listings found."); }
        }

        // --- OPEN PROPERTY PAGE LOGIC ---
        function openPropertyPage(prop) {
            // 1. Switch Views
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('property-page').classList.remove('hidden');
            window.scrollTo(0,0);

            // 2. Inject Data
            document.getElementById('detail-title').innerText = `Property in ${prop.area}`;
            document.getElementById('detail-address').innerText = `üìç ${prop.houseNo}, ${prop.street}, ${prop.city}`;
            document.getElementById('detail-owner').innerText = prop.firstName;
            document.getElementById('detail-img-main').src = prop.imageUrl || 'https://via.placeholder.com/800x600?text=No+Image';

            // 3. Fake Price (Randomized for demo)
            const randomPrice = Math.floor(Math.random() * (90 - 40 + 1) + 40);
            document.getElementById('detail-price').innerText = `${randomPrice} Lakhs`;

            // 4. Contact Buttons
            document.getElementById('btn-call').href = `tel:${prop.phone}`;
            document.getElementById('btn-whatsapp').href = `https://wa.me/91${prop.phone}?text=Hi, I am interested in your property at ${prop.area}`;
            document.getElementById('street-view-btn').href = `https://www.google.com/maps?layer=c&cbll=${prop.lat},${prop.lng}`;

            // 5. Mini Map inside Page
            if(detailMap) detailMap.remove(); // Reset map
            detailMap = L.map('detail-map').setView([prop.lat, prop.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
            L.marker([prop.lat, prop.lng]).addTo(detailMap);
        }

        // --- EMI CALCULATOR ---
        function calculateEMI() {
            const principal = document.getElementById('loan-amount').value;
            if(!principal) return;
            const rate = 8.5 / 12 / 100; // 8.5% Interest
            const tenure = 240; // 20 Years
            const emi = principal * rate * (Math.pow(1 + rate, tenure) / (Math.pow(1 + rate, tenure) - 1));
            document.getElementById('emi-val').innerText = "‚Çπ " + Math.round(emi).toLocaleString();
        }

        checkSession();
    </script>
</body>
</html>